"use strict";(self.webpackChunksc_depot=self.webpackChunksc_depot||[]).push([[38424,62128,71220,96500],{38424:(e,t,i)=>{i.r(t),i.d(t,{default:()=>h});var o=i(35143),a=i(42553),r=i(46053),n=(i(81806),i(76460),i(47249),i(28379)),s=i(85842),l=i(17707),d=i(23701),u=i(12899),c=i(64533);let p=class extends a.A{constructor(e){super(e),this.globalId=null,this.associationType=null,this.fromNetworkElement=null,this.toNetworkElement=null,this.geometry=null,this.errorMessage=null,this.percentAlong=null,this.errorCode=null,this.isContentVisible=null,this.status=null}readFromNetworkElement(e,t){return new c.default({globalId:t.fromGlobalId,networkSourceId:t.fromNetworkSourceId,terminalId:t.fromTerminalId})}writeFromNetworkElement(e,t){e&&(t.fromGlobalId=e.globalId,t.fromNetworkSourceId=e.networkSourceId,t.fromTerminalId=e.terminalId)}readToNetworkElement(e,t){return new c.default({globalId:t.toGlobalId,networkSourceId:t.toNetworkSourceId,terminalId:t.toTerminalId})}writeToNetworkElement(e,t){e&&(t.toGlobalId=e.globalId,t.toNetworkSourceId=e.networkSourceId,t.toTerminalId=e.terminalId)}};(0,o._)([(0,r.MZ)({type:String,json:{write:!0}})],p.prototype,"globalId",void 0),(0,o._)([(0,r.MZ)({type:u.XZ.apiValues,json:{type:u.XZ.jsonValues,read:u.XZ.read,write:u.XZ.write}})],p.prototype,"associationType",void 0),(0,o._)([(0,r.MZ)({type:c.default,json:{write:{target:{fromGlobalId:{type:String},fromNetworkSourceId:{type:Number},fromTerminalId:{type:Number}}},read:{source:["fromGlobalId","fromNetworkSourceId","fromTerminalId"]}}})],p.prototype,"fromNetworkElement",void 0),(0,o._)([(0,n.w)("fromNetworkElement")],p.prototype,"readFromNetworkElement",null),(0,o._)([(0,l.K)("fromNetworkElement")],p.prototype,"writeFromNetworkElement",null),(0,o._)([(0,r.MZ)({type:c.default,json:{write:{target:{toGlobalId:{type:String},toNetworkSourceId:{type:Number},toTerminalId:{type:Number}}},read:{source:["toGlobalId","toNetworkSourceId","toTerminalId"]}}})],p.prototype,"toNetworkElement",void 0),(0,o._)([(0,n.w)("toNetworkElement")],p.prototype,"readToNetworkElement",null),(0,o._)([(0,l.K)("toNetworkElement")],p.prototype,"writeToNetworkElement",null),(0,o._)([(0,r.MZ)({type:d.default,json:{write:!0}})],p.prototype,"geometry",void 0),(0,o._)([(0,r.MZ)({type:String,json:{write:!0}})],p.prototype,"errorMessage",void 0),(0,o._)([(0,r.MZ)({type:Number,json:{write:!0}})],p.prototype,"percentAlong",void 0),(0,o._)([(0,r.MZ)({type:Number,json:{write:!0}})],p.prototype,"errorCode",void 0),(0,o._)([(0,r.MZ)({type:Boolean,json:{write:!0}})],p.prototype,"isContentVisible",void 0),(0,o._)([(0,r.MZ)({type:Number,json:{write:!0}})],p.prototype,"status",void 0),p=(0,o._)([(0,s.$)("esri.rest.networks.support.Association")],p);const h=p},47254:(e,t,i)=>{function o(e){return null!=e&&"object"==typeof e&&"type"in e&&null!==e.type&&("column"===e.type||"field"===e.type||"group"===e.type||"attachment"===e.type||"relationship"===e.type)}function a(e){return!(!e||!("field"in e))}function r(e){return!(!e||!("columns"in e))}function n(e){return!(!e||!("relationshipId"in e))}function s(e){return!(!e||!("onShowAttachments"in e))}i.d(t,{CE:()=>o,DU:()=>s,Ie:()=>r,JY:()=>a,Lv:()=>n})},62128:(e,t,i)=>{i.r(t),i.d(t,{default:()=>l});var o=i(35143),a=i(91967),r=i(46053),n=(i(81806),i(76460),i(47249),i(85842));let s=class extends a.default{constructor(e){super(e),this.addAttachmentsCallback=null,this.applyEditsCallback=null,this.applyEditsFeatureServiceCallback=null,this.candidates=null,this.rootFeature=null,this.sketchOptions=null,this.snappingManager=null,this.viewModel=null}};(0,o._)([(0,r.MZ)()],s.prototype,"addAttachmentsCallback",void 0),(0,o._)([(0,r.MZ)()],s.prototype,"applyEditsCallback",void 0),(0,o._)([(0,r.MZ)()],s.prototype,"applyEditsFeatureServiceCallback",void 0),(0,o._)([(0,r.MZ)()],s.prototype,"candidates",void 0),(0,o._)([(0,r.MZ)()],s.prototype,"rootFeature",void 0),(0,o._)([(0,r.MZ)({constructOnly:!0})],s.prototype,"sketchOptions",void 0),(0,o._)([(0,r.MZ)()],s.prototype,"snappingManager",void 0),(0,o._)([(0,r.MZ)()],s.prototype,"viewModel",void 0),s=(0,o._)([(0,n.$)("esri.widgets.Editor.UpdateWorkflowData")],s);const l=s},71220:(e,t,i)=>{i.r(t),i.d(t,{createFeatureServices:()=>n});var o=i(13096),a=i(8163);const r=(e,t)=>{for(const i of e)if("feature"===i.type||"subtype-group"===i.type){if(!i.url)continue;const e=(0,o.qg)(i.url).url.path,r=t.get(e);if(r)r.layers.push(i);else{const o=new a.default({url:e}),r=[i];t.set(e,{featureService:o,layers:r})}}else"group"===i.type&&r(i.layers.filter((e=>"feature"===e.type||"subtype-group"===e.type||"group"===e.type)),t)};function n(e){const t=new Map;return r(e,t),t}},78984:(e,t,i)=>{i.d(t,{$m:()=>w,A5:()=>c,Dv:()=>f,Gx:()=>A,He:()=>d,Kc:()=>g,TV:()=>y,UI:()=>m,YX:()=>_,aq:()=>k,cS:()=>h,d0:()=>l,hg:()=>s,iH:()=>b,k$:()=>r,pJ:()=>p,sR:()=>v,xf:()=>u,zz:()=>n});var o=i(47254),a=i(94126);const r={action:"EsriFeatureTableActionColumn",attachments:"EsriFeatureTableAttachmentsColumn",relationship:"EsriFeatureTableRelationshipColumn"},n=()=>Promise.all([(0,a.W)({"action-bar":()=>Promise.resolve().then(i.bind(i,143))}),Promise.all([(0,a.W)({input:()=>Promise.all([i.e(46870),i.e(38841)]).then(i.bind(i,38841)),option:()=>i.e(46422).then(i.bind(i,46422)),select:()=>i.e(2253).then(i.bind(i,2253)),"input-date-picker":()=>Promise.all([i.e(46870),i.e(79709),i.e(53433)]).then(i.bind(i,40240)),"input-time-picker":()=>Promise.all([i.e(46870),i.e(5506)]).then(i.bind(i,5506))}),(0,a.W)({action:()=>Promise.resolve().then(i.bind(i,85375)),button:()=>Promise.resolve().then(i.bind(i,43285)),dropdown:()=>Promise.resolve().then(i.bind(i,24482)),"dropdown-item":()=>Promise.resolve().then(i.bind(i,84660)),"dropdown-group":()=>Promise.resolve().then(i.bind(i,5368)),icon:()=>Promise.resolve().then(i.bind(i,16702))})])]);function s(e){return null!=e&&"object"==typeof e&&"createQuery"in e&&"getField"in e&&"queryFeatureCount"in e&&"queryFeatures"in e&&"queryObjectIds"in e&&"capabilities"in e&&"fields"in e&&"fieldsIndex"in e&&"id"in e&&"load"in e&&"objectIdField"in e&&"type"in e&&"when"in e}function l(e){return s(e)&&"queryAttachments"in e}function d(e){return l(e)&&"addAttachment"in e&&"deleteAttachments"in e&&"updateAttachment"in e}function u(e){return s(e)&&"editingEnabled"in e&&"applyEdits"in e}function c(e){return s(e)&&"relationships"in e&&"queryRelatedFeatures"in e&&"queryRelatedFeaturesCount"in e}function p(e){return null!=e&&"object"==typeof e&&"type"in e&&"map-image"===e.type}function h(e,t,i){if(null!==t&&void 0!==t&&t.map)return y(e,[...t.map.allLayers,...t.map.allTables],i)}function y(e,t,i){let{relatedTableId:o}=i;const a="scene"===e.type&&e.associatedLayer?e.associatedLayer.url:e.url,r=t=>{var i;return!(!c(t)||t===e)&&("sublayer"===t.type&&(null===(i=t.layer)||void 0===i?void 0:i.url)===e.url?t.id===o:a===t.url&&t.layerId===o)};if("sublayer"===e.type&&p(e.parent)){var n,s;const t=t=>c(t)&&t!==e&&t.id===o,i=e.parent,a=(null===(n=i.sublayers)||void 0===n?void 0:n.find(t))||(null===(s=i.subtables)||void 0===s?void 0:s.find(t));if(c(a))return a}let l=null;for(const c of t)if(p(c)){var d,u;const e=(null===(d=c.sublayers)||void 0===d?void 0:d.find(r))||(null===(u=c.subtables)||void 0===u?void 0:u.find(r));if(e){l=e;break}}else if(r(c)){l=c;break}if(c(l))return l}function v(e,t){return null!=e&&Number.isInteger(e)&&e>-1&&e<t}function w(e){return null==e||0===e.trim().length}function f(e,t){var i;return(null!==(i=e.relationships)&&void 0!==i?i:[]).filter((e=>!(e.id===t&&"one-to-one"===e.cardinality))).map((e=>{let{id:t}=e;return{relationshipId:t}}))}function g(e,t){var i;return null===(i=e.relationships)||void 0===i?void 0:i.find((e=>{let{id:i}=e;return i===t}))}function m(e,t){var i;return null==t?null:null===e||void 0===e||null===(i=e.fields)||void 0===i?void 0:i.find((e=>{var i;return t.toLowerCase()===(null===(i=e.name)||void 0===i?void 0:i.toLowerCase())}))}function _(e,t){return t.some((t=>!("group"!==t.type||!_(e,t.columnTemplates))||t.fieldName===e))}function k(e,t){var i;return null!==(i=null===t||void 0===t?void 0:t.some((t=>!(!(0,o.Ie)(t)||!k(e,t.columns))||t.fieldName===e)))&&void 0!==i&&i}function b(e,t){return"".concat(e.id,"-").concat(t)}function A(e){return e.isTable?"table":"feature"===e.type?"feature-layer":"layer"}},82141:(e,t,i)=>{i.d(t,{A:()=>I});var o=i(35143),a=i(39356),r=i(91967),n=i(98773),s=i(19276),l=i(30726),d=i(50346),u=i(68134),c=i(34154),p=i(46053),h=(i(81806),i(76460),i(47249),i(85842)),y=i(19451),v=i(74691),w=i(31933),f=i(9912),g=i(78984),m=i(49723),_=i(38424),k=i(64533);function b(e){return new _.default({fromNetworkElement:A(e.fromFeature,e.utilityNetwork),toNetworkElement:A(e.toFeature,e.utilityNetwork),associationType:e.associationType,globalId:(0,m.yS)()})}function A(e,t){const i=(0,w.Sv)(e.sourceLayer)?e.sourceLayer.parent:e.sourceLayer;if(i&&"globalIdField"in i&&"layerId"in i&&i.globalIdField){var o;const a=t.getSourceIdByLayerId(i.layerId),r="junction"===t.getSourceTypeById(a)?t.getTerminalConfiguration(e):void 0,n=null===r||void 0===r||null===(o=r.terminals.at(0))||void 0===o?void 0:o.id,s=i.fieldsIndex.get("assetGroup").name,l=i.fieldsIndex.get("assetType").name,d=e.attributes[s],u=e.attributes[l],c=e.attributes[i.globalIdField];if(c&&null!=a)return new k.default({globalId:c,networkSourceId:a,assetGroupCode:d,assetTypeCode:u,terminalId:n})}}var M=i(26547);const F="association-key";let C=class extends r.default{constructor(e){super(e),this.graphic=null,this.layer=null,this.map=null,this.utilityNetwork=null,this.associationType=null,this.featureCount=0,this._queryAbortController=null,this._queryPageAbortController=null,this._queryFeatureCountAbortController=null,this.featuresPerPage=30,this.selectedFeature=null,this.association=null,this.filterOptionsVisible=!1,this.filterWhereClause=null,this._rulesTable=null,this._canAssociate=!1,this._whereClause=null,this._setUpItemsTask=null,this._updatingHandlesSetUp=new y.U,this._queryFeaturesTask=null,this._updatingHandlesQueryFeatures=new y.U,this._validateAssociationTask=null,this._updatingHandlesAssociation=new y.U,this._cancelQuery=()=>{const{_queryAbortController:e}=this;e&&e.abort(),this._queryAbortController=null},this._cancelQueryFeatureCount=()=>{const{_queryFeatureCountAbortController:e}=this;e&&e.abort(),this._queryFeatureCountAbortController=null},this._cancelQueryPage=()=>{const{_queryPageAbortController:e}=this;e&&e.abort(),this._queryPageAbortController=null},this._queryController=async()=>{this._cancelQuery();const e=new AbortController;this._queryAbortController=e,await(0,d.ignoreAbortErrors)(this._query()).catch((()=>this._cancelQuery())),this._queryAbortController===e&&(this._queryAbortController=null)},this._queryFeatureCountController=async e=>{this._cancelQueryFeatureCount();const t=new AbortController;this._queryFeatureCountAbortController=t,await(0,d.ignoreAbortErrors)(this._queryFeatureCount(e)).catch((()=>this._cancelQueryFeatureCount())),this._queryFeatureCountAbortController===t&&(this._queryFeatureCountAbortController=null)},this._queryPageController=async()=>{const e=new AbortController;this._queryPageAbortController=e,await(0,d.ignoreAbortErrors)(this._queryPage()).catch((()=>this._cancelQueryPage())),this._queryPageAbortController===e&&(this._queryPageAbortController=null)},this._queryDebounced=(0,d.debounce)(this._queryController,100),this._queryFeatureCountDebounced=(0,d.debounce)(this._queryFeatureCountController,100),this._queryPageDebounced=(0,d.debounce)(this._queryPageController,100)}initialize(){this.addHandles([(0,u.watch)((()=>[this.graphic,this.layer,this.map,this.utilityNetwork,this.globalId,this.associationType]),(()=>this._syncLayerItems()),u.initial),(0,u.watch)((()=>[this.selectedLayer,this.filterWhereClause,this.featuresPerPage]),(()=>{this.selectedLayer&&this._setUpFeatures()})),(0,u.watch)((()=>this.selectedFeature),(()=>{this._setUpAssociation()})),(0,u.watch)((()=>this.featurePage),(()=>this._queryPageDebounced()))])}destroy(){this._setUpItemsTask=(0,l.DC)(this._setUpItemsTask),this._updatingHandlesSetUp.destroy(),this._queryFeaturesTask=(0,l.DC)(this._queryFeaturesTask),this._updatingHandlesQueryFeatures.destroy(),this._validateAssociationTask=(0,l.DC)(this._validateAssociationTask),this._updatingHandlesAssociation.destroy(),this._cancelQuery(),this._cancelQueryFeatureCount(),this._cancelQueryPage()}get mapLayers(){const{map:e}=this;if(!e)return null;const t=new Set,i=e=>{!(0,f.isAssociatedFeatureSupportedLayer)(e)||(0,w.F2)(e)||t.has(e)||t.add(e)},o=e=>{var t,o,a,r,n;(0,v.isLayerFromCatalog)(e)||"catalog-footprint"===e.type||((0,w.cM)(e)?(null!==(t=e.layers)&&void 0!==t&&t.forEach(i),null===(o=e.tables)||void 0===o||o.forEach(i)):(0,g.pJ)(e)?(null!==(a=e.sublayers)&&void 0!==a&&a.forEach(i),null===(r=e.subtables)||void 0===r||r.forEach(i)):(0,w.F2)(e)?null===(n=e.sublayers)||void 0===n||n.forEach(i):i(e))};return e.allLayers.forEach(o),e.allTables.forEach(o),new s.default([...t])}get state(){const{_queryAbortController:e,_queryPageAbortController:t,canQuery:i}=this;return e||t||this._updatingHandlesQueryFeatures.updating?"querying":this.canLoad&&this._updatingHandlesSetUp.updating?"loading":this._updatingHandlesAssociation.updating?"validating":i?"ready":"disabled"}get canAddAssociation(){return!(this.updating||!this.association)&&this._canAssociate}get globalId(){var e,t;return null!==(e=this.globalIdField&&(null===(t=this.graphic)||void 0===t||null===(t=t.attributes)||void 0===t?void 0:t[this.globalIdField]))&&void 0!==e?e:null}get globalIdField(){var e;const{layer:t}=this;return null!==(e=null===t||void 0===t?void 0:t.globalIdField)&&void 0!==e?e:null}get layerItems(){return this._get("layerItems")||new s.default}get featureItems(){return this._get("featureItems")||new s.default}set featurePage(e){const{featuresPerPage:t,featureCount:i}=this,o=Math.ceil(i/t)||1;this._set("featurePage",Math.min(Math.max(e,1),o))}get featurePage(){return this._get("featurePage")}get canLoad(){const{map:e,utilityNetwork:t,graphic:i,associationType:o}=this;return!!(e&&t&&i&&o)}get canQuery(){const{utilityNetwork:e,graphic:t,associationType:i,selectedLayer:o}=this;return!!(e&&t&&i&&o)}get updating(){return this._updatingHandlesSetUp.updating||this._updatingHandlesAssociation.updating}get selectedLayer(){return this._get("selectedLayer")}set selectedLayer(e){e!==this.selectedLayer&&(this.filterWhereClause=null),this._set("selectedLayer",e)}get queryWhereClause(){const{_whereClause:e,filterWhereClause:t}=this;return(0,c.sqlAnd)(e,t)}async _queryFeatureCount(e){const{selectedLayer:t,_queryFeatureCountAbortController:i}=this;if(this._set("featureCount",0),!t)return;await t.load();const o=t.createQuery();o.returnGeometry=!1,o.where=(0,c.sqlAnd)(o.where,e);const a=await t.queryFeatureCount(o,{signal:null===i||void 0===i?void 0:i.signal});a>0&&this._set("featureCount",a)}async _query(){const{canQuery:e,queryWhereClause:t,_queryAbortController:i,featureItems:o}=this;e&&(this.featurePage=1,o.destroyAll(),this.featureCount&&!this.destroyed&&o.addMany(await this._queryAssociatedFeatures(t,{signal:null===i||void 0===i?void 0:i.signal})))}async _queryPage(){const{canQuery:e,queryWhereClause:t,featurePage:i,_queryPageAbortController:o,featureCount:a,featureItems:r}=this;e&&(i<2||!a||r.addMany(await this._queryAssociatedFeatures(t,{signal:null===o||void 0===o?void 0:o.signal})))}_convertTypeToDirection(e){switch(e){case"attachment":return[{type:"attachment",direction:"from"}];case"connectivity":return[{type:"junction-junction-connectivity"},{type:"junction-edge-from-connectivity"},{type:"junction-edge-midspan-connectivity"},{type:"junction-edge-to-connectivity"}];case"container":return[{type:"containment",direction:"to"}];case"content":return[{type:"containment",direction:"from"}];case"structure":return[{type:"attachment",direction:"to"}]}}async getRulesTable(){const{utilityNetwork:e}=this;if(!e)return null;if(this._rulesTable)return this._rulesTable;const t=await e.getRulesTable();return await(null===t||void 0===t?void 0:t.load()),this._rulesTable=t,t}async _syncLayerItems(){(0,l.DC)(this._setUpItemsTask);const{graphic:e,associationType:t,layerItems:i,canLoad:o}=this,a=(0,n.UT)((async a=>{var r;if(this.selectedLayer=null,i.destroyAll(),!o)return;const n=null===(r=this.mapLayers)||void 0===r?void 0:r.toArray();if(!n)return;if(a.aborted)return;const s=await this.getRulesTable(),l=this._convertTypeToDirection(t.type),d=null===s||void 0===s?void 0:s.getLayersCanAssociateWith(e,n,l);a.aborted||i.addMany(d||[])}));this._updatingHandlesSetUp.addPromise(a.promise),this._setUpItemsTask=a}async _setUpFeatures(){(0,l.DC)(this._queryFeaturesTask);const{graphic:e,associationType:t,selectedLayer:i,canQuery:o}=this;if(!o)return;const a=(0,n.UT)((async o=>{const a=await this.getRulesTable(),r=this._convertTypeToDirection(t.type),n=null===a||void 0===a?void 0:a.getFeaturesCanAssociateWithClause(e,i,r);this._whereClause=n,o.aborted||(await this._queryFeatureCountDebounced(this.queryWhereClause),await this._queryDebounced())}));this._updatingHandlesQueryFeatures.addPromise(a.promise),this._queryFeaturesTask=a}_determineFromAndTo(e,t,i){return"from"===i?{fromFeature:e,toFeature:t}:{fromFeature:t,toFeature:e}}_determineJunctionEdgeConnectivity(e,t){const{utilityNetwork:i}=this,o=(0,w.Sv)(e.sourceLayer)?e.sourceLayer.parent:e.sourceLayer,a=(0,w.Sv)(t.sourceLayer)?t.sourceLayer.parent:t.sourceLayer;if(!(i&&o&&"layerId"in o&&a&&"layerId"in a))return{fromFeature:e,toFeature:t,type:"junction-junction-connectivity"};const r=i.getSourceIdByLayerId(o.layerId),n=i.getSourceIdByLayerId(a.layerId);if(!r||!n)return{fromFeature:e,toFeature:t,type:"junction-junction-connectivity"};const s="junction"===i.getSourceTypeById(r),l="junction"===i.getSourceTypeById(n);return s&&l?{fromFeature:e,toFeature:t,type:"junction-junction-connectivity"}:l?{fromFeature:t,toFeature:e,type:"junction-edge-midspan-connectivity"}:{fromFeature:e,toFeature:t,type:"junction-edge-midspan-connectivity"}}_setUpAssociationHandles(){this.removeHandles(F),this.association&&this.addHandles((0,u.watch)((()=>{var e,t,i,o,a;return[null===(e=this.association)||void 0===e?void 0:e.associationType,null===(t=this.association)||void 0===t?void 0:t.fromNetworkElement,null===(i=this.association)||void 0===i||null===(i=i.fromNetworkElement)||void 0===i?void 0:i.terminalId,null===(o=this.association)||void 0===o?void 0:o.toNetworkElement,null===(a=this.association)||void 0===a||null===(a=a.toNetworkElement)||void 0===a?void 0:a.terminalId]}),(()=>this.validateAssociation()),u.initial),F)}_setUpAssociation(){const{utilityNetwork:e,graphic:t,selectedFeature:i,associationType:o}=this;if(!(e&&t&&i&&o))return void(this.association=null);const a=this._convertTypeToDirection(o.type);if(a.length>1){const{fromFeature:o,toFeature:a,type:r}=this._determineJunctionEdgeConnectivity(t,i.feature);return this.association=b({fromFeature:o,toFeature:a,utilityNetwork:e,associationType:r}),void this._setUpAssociationHandles()}const{fromFeature:r,toFeature:n}=this._determineFromAndTo(t,i.feature,a[0].direction);this.association=b({fromFeature:r,toFeature:n,utilityNetwork:e,associationType:a[0].type}),this._setUpAssociationHandles()}async _processFeatures(e){return Promise.all(e.map((async e=>{const{sourceLayer:t}=e;return t&&"getFeatureTitle"in t?{label:await t.getFeatureTitle(e),feature:e}:{label:(0,M.R)(e),feature:e}})))}async _queryAssociatedFeatures(e,t){const{featuresPerPage:i,layer:o,featurePage:a,featureCount:r,selectedLayer:n}=this,{canQuery:s,globalId:l}=this;if(!s||!o||!n||null==l)return[];const d=((a-1)*i+r)%r,u=i,{historicMoment:p,gdbVersion:h}=n,y=n.createQuery();y.where=(0,c.sqlAnd)(y.where,e),y.start=d,y.num=u,y.returnGeometry=!1,y.historicMoment=p,y.gdbVersion=h,y.outFields=["*"];const v=await n.queryFeatures(y,{signal:null===t||void 0===t?void 0:t.signal});return await this._processFeatures(v.features)}validateAssociation(){(0,l.DC)(this._validateAssociationTask);const{utilityNetwork:e,association:t}=this,i=(0,n.UT)((async()=>{e&&t&&(this._canAssociate=await e.canAddAssociation(t))}));this._updatingHandlesAssociation.addPromise(i.promise),this._validateAssociationTask=i}};(0,o._)([(0,p.MZ)({type:a.default})],C.prototype,"graphic",void 0),(0,o._)([(0,p.MZ)()],C.prototype,"layer",void 0),(0,o._)([(0,p.MZ)()],C.prototype,"map",void 0),(0,o._)([(0,p.MZ)({readOnly:!0})],C.prototype,"mapLayers",null),(0,o._)([(0,p.MZ)()],C.prototype,"utilityNetwork",void 0),(0,o._)([(0,p.MZ)()],C.prototype,"associationType",void 0),(0,o._)([(0,p.MZ)()],C.prototype,"state",null),(0,o._)([(0,p.MZ)({readOnly:!0})],C.prototype,"canAddAssociation",null),(0,o._)([(0,p.MZ)({readOnly:!0})],C.prototype,"globalId",null),(0,o._)([(0,p.MZ)({readOnly:!0})],C.prototype,"globalIdField",null),(0,o._)([(0,p.MZ)()],C.prototype,"featureCount",void 0),(0,o._)([(0,p.MZ)({readOnly:!0})],C.prototype,"layerItems",null),(0,o._)([(0,p.MZ)({readOnly:!0})],C.prototype,"featureItems",null),(0,o._)([(0,p.MZ)()],C.prototype,"_queryAbortController",void 0),(0,o._)([(0,p.MZ)()],C.prototype,"_queryPageAbortController",void 0),(0,o._)([(0,p.MZ)()],C.prototype,"_queryFeatureCountAbortController",void 0),(0,o._)([(0,p.MZ)({value:1})],C.prototype,"featurePage",null),(0,o._)([(0,p.MZ)()],C.prototype,"featuresPerPage",void 0),(0,o._)([(0,p.MZ)({readOnly:!0})],C.prototype,"canLoad",null),(0,o._)([(0,p.MZ)({readOnly:!0})],C.prototype,"canQuery",null),(0,o._)([(0,p.MZ)({readOnly:!0})],C.prototype,"updating",null),(0,o._)([(0,p.MZ)()],C.prototype,"selectedLayer",null),(0,o._)([(0,p.MZ)()],C.prototype,"selectedFeature",void 0),(0,o._)([(0,p.MZ)()],C.prototype,"association",void 0),(0,o._)([(0,p.MZ)()],C.prototype,"filterOptionsVisible",void 0),(0,o._)([(0,p.MZ)()],C.prototype,"filterWhereClause",void 0),(0,o._)([(0,p.MZ)()],C.prototype,"queryWhereClause",null),(0,o._)([(0,p.MZ)()],C.prototype,"_rulesTable",void 0),(0,o._)([(0,p.MZ)()],C.prototype,"_canAssociate",void 0),(0,o._)([(0,p.MZ)()],C.prototype,"_whereClause",void 0),C=(0,o._)([(0,h.$)("esri.widgets.FeatureForm.UtilityNetworkAssociationAddAssociationViewModel")],C);const I=C},96500:(e,t,i)=>{i.r(t),i.d(t,{default:()=>se});var o,a=i(35143),r=i(39356),n=i(50076),s=i(54901),l=i(76460),d=i(30726),u=i(50346),c=i(59649),p=i(68134),h=i(41289),y=i(46053),v=(i(81806),i(47249),i(85842)),w=i(70445),f=i(31933),g=i(71220),m=i(20072),_=i(57308),k=i(97513),b=i(1723),A=i(91967);let M=o=class extends A.default{constructor(e){super(e),this.editorItem=null,this.feature=null,this.utilityNetwork=null,this.associationType=null,this.parent=null,this.associationInput=null,this.viewModel=null}static async create(e){const{feature:t,parent:i,viewModel:a,utilityNetwork:r,associationType:s,associationInput:l}=e,d=a.editorItems.find((e=>e.layer===t.layer));if(!d)throw new n.default("no-editorItem-found","The EditorViewModel provided did not have an EditorItem associated with the specified Graphic's layer");return new o({editorItem:d,feature:t,parent:i,viewModel:a,utilityNetwork:r,associationType:s,associationInput:l})}};(0,a._)([(0,y.MZ)({constructOnly:!0})],M.prototype,"editorItem",void 0),(0,a._)([(0,y.MZ)()],M.prototype,"feature",void 0),(0,a._)([(0,y.MZ)({constructOnly:!0})],M.prototype,"utilityNetwork",void 0),(0,a._)([(0,y.MZ)({constructOnly:!0})],M.prototype,"associationType",void 0),(0,a._)([(0,y.MZ)()],M.prototype,"parent",void 0),(0,a._)([(0,y.MZ)()],M.prototype,"associationInput",void 0),(0,a._)([(0,y.MZ)()],M.prototype,"viewModel",void 0),M=o=(0,a._)([(0,v.$)("esri.widgets.Editor.AddAssociationWorkflowData")],M);const F=M;var C,I=i(88877),S=i(95600),T=i(82141),Z=i(26547);const E={exit:Symbol()};let V=C=class extends I.default{constructor(e){super(e),this._utilityNetworkAssociationAddAssociationViewModel=new T.A,this._highlightHelper=null,this.sourceFeatureItem=null,this.type="add-association"}initialize(){const{data:e}=this,{view:t}=e.viewModel;t&&(this._highlightHelper=new m.A({view:t,highlightName:b.n4}),this.addHandles((0,s.hA)((()=>{var e;return null===(e=this._highlightHelper)||void 0===e?void 0:e.removeAll()}))));const i=new AbortController;this.addHandles((0,s.rE)(i)),this._updatingHandles.addPromise(this._setup(i))}get editorItem(){return this.data.editorItem}get featureFormViewModel(){return this._featureFormViewModel}get utilityNetworkAssociationAddAssociationViewModel(){return this._utilityNetworkAssociationAddAssociationViewModel}get hasPendingEdits(){return!!this._utilityNetworkAssociationAddAssociationViewModel.selectedFeature}get layer(){return this.data.editorItem.layer}get parent(){return this.data.parent}get parentLayer(){var e;return null===(e=this.parent)||void 0===e?void 0:e.data.editorItem.layer}get reliesOnOwnerAdminPrivileges(){return this.editorItem.capabilities.create.reliesOnOwnerAdminPrivileges}async enter(){this._initializeUtilityNetworkAssociationAddAssociationViewModel()}exit(){this.removeHandles(E.exit)}async start(){return await super.start(),null}async _setup(e){const{data:t}=this,{feature:i}=t;try{const o=await(0,S.mU)(i,t.viewModel.view.spatialReference,e.signal);if((0,u.isAborted)(e))return;const a=o.sourceLayer&&"getFeatureTitle"in o.sourceLayer?await o.sourceLayer.getFeatureTitle(o):(0,Z.R)(o);if((0,u.isAborted)(e))return;this.sourceFeatureItem={feature:i,label:a},this._initializeUtilityNetworkAssociationAddAssociationViewModel()}catch(o){this.cancel({force:!0,error:new n.default("editor:failed-to-fetch-full-feature","Failed to retrieve all information for this feature. The update cannot proceed.",{detail:{error:o}})})}}_initializeUtilityNetworkAssociationAddAssociationViewModel(){const{viewModel:{view:e},utilityNetwork:t,associationType:i}=this.data,o=this._utilityNetworkAssociationAddAssociationViewModel;o.graphic=this.sourceFeatureItem.feature,o.map=null===e||void 0===e?void 0:e.map,o.utilityNetwork=t,o.layer=this.layer,o.associationType=i,t.networkSystemLayers.loadAssociationsTable(),this.addHandles([(0,p.watch)((()=>o.selectedLayer),(e=>{e&&this.go("add-association-select-feature")})),(0,p.watch)((()=>o.selectedFeature),(e=>{e&&this.go("add-association-create-association")}))],E.exit)}static async create(e){const t=new C({data:await F.create(e),onCommit:this._onCommitFactory(e.applyEditsFeatureService)});return t._set("steps",this._createWorkflowSteps(t)),t}static _createWorkflowSteps(e){return[{id:"add-association-select-layer",async setUp(){const{utilityNetworkAssociationAddAssociationViewModel:t}=e.data.viewModel;t&&(t.selectedLayer=null,t.selectedFeature=null,t.association=null)},async tearDown(){}},{id:"add-association-select-feature",async setUp(){const{utilityNetworkAssociationAddAssociationViewModel:t}=e.data.viewModel;t&&(t.selectedFeature=null,t.association=null)},async tearDown(){}},{id:"add-association-create-association",async setUp(){},async tearDown(){}}]}};V._onCommitFactory=e=>async t=>{var i,o;const{feature:a,utilityNetwork:r,associationInput:s}=t,{utilityNetworkAssociationAddAssociationViewModel:l}=t.viewModel,{association:d}=l;await r.networkSystemLayers.loadAssociationsTable();const u=null===r||void 0===r?void 0:r.generateAddAssociations([d]);if(!u)throw new n.default("editor:failed-to-add-association","Could not create payload needed to add association");const c=a.sourceLayer,p=(0,f.Sv)(c)&&c.parent?c.parent:c,h=null===(i=(0,g.createFeatureServices)([p]).values().next().value)||void 0===i?void 0:i.featureService;if(!h)throw new n.default("editor:failed-to-delete-association","Could not retrieve feature service needed to delete association");await(null===h||void 0===h?void 0:h.load());const y=null!==(o=null===r||void 0===r?void 0:r.gdbVersion)&&void 0!==o?o:void 0;await e(h,[u],{gdbVersion:y}),await s.refresh()},(0,a._)([(0,y.MZ)()],V.prototype,"_utilityNetworkAssociationAddAssociationViewModel",void 0),(0,a._)([(0,y.MZ)()],V.prototype,"_featureFormViewModel",void 0),(0,a._)([(0,y.MZ)()],V.prototype,"editorItem",null),(0,a._)([(0,y.MZ)()],V.prototype,"featureFormViewModel",null),(0,a._)([(0,y.MZ)()],V.prototype,"utilityNetworkAssociationAddAssociationViewModel",null),(0,a._)([(0,y.MZ)()],V.prototype,"sourceFeatureItem",void 0),(0,a._)([(0,y.MZ)()],V.prototype,"hasPendingEdits",null),(0,a._)([(0,y.MZ)()],V.prototype,"layer",null),(0,a._)([(0,y.MZ)()],V.prototype,"parent",null),(0,a._)([(0,y.MZ)()],V.prototype,"parentLayer",null),(0,a._)([(0,y.MZ)()],V.prototype,"reliesOnOwnerAdminPrivileges",null),V=C=(0,a._)([(0,v.$)("esri.widgets.Editor.AddAssociationWorkflow")],V);var W,N=i(7141),P=i(89379),L=i(63733),q=i(12482),H=i(90992),U=i(79256);let O=W=class extends A.default{constructor(e){super(e),this.association=null,this.editorItem=null,this.edits=null,this.parent=null,this.featureFormCallbacks=null,this.viewModel=null}get attachmentsCapabilities(){const e=this.editorItem.capabilities.update.attachments.enabled;return{editing:!0,operations:{add:e,update:e,delete:e}}}get formTemplate(){return this.editorItem.formTemplate}static async create(e){const t=W._makeConstructorProps(e);return new W(t)}static _makeConstructorProps(e){const{association:t,feature:i,parent:o,featureFormCallbacks:a,viewModel:r}=e,s=r.editorItems.find((e=>e.layer===i.layer));if(!s)throw new n.default("no-editorItem-found","The EditorViewModel provided did not have an EditorItem associated with the specified Graphic's layer");return{association:t,editorItem:s,edits:new U.default({feature:i}),parent:o,featureFormCallbacks:a,viewModel:r}}};(0,a._)([(0,y.MZ)()],O.prototype,"association",void 0),(0,a._)([(0,y.MZ)()],O.prototype,"attachmentsCapabilities",null),(0,a._)([(0,y.MZ)({constructOnly:!0})],O.prototype,"editorItem",void 0),(0,a._)([(0,y.MZ)()],O.prototype,"edits",void 0),(0,a._)([(0,y.MZ)()],O.prototype,"formTemplate",null),(0,a._)([(0,y.MZ)()],O.prototype,"parent",void 0),(0,a._)([(0,y.MZ)()],O.prototype,"featureFormCallbacks",void 0),(0,a._)([(0,y.MZ)()],O.prototype,"viewModel",void 0),O=W=(0,a._)([(0,v.$)("esri.widgets.Editor.UpdateRecordWorkflowData")],O);const D=O;var x;let R=x=class extends D{constructor(e){super(e),this.sketchOptions=null,this.snappingManager=null}static async create(e){var t;const{feature:i,snappingManager:o,viewModel:a}=e,r=null!==(t=e.sketchOptions)&&void 0!==t?t:new k.A,{view:s}=a;if(!s)throw new n.default("editor:cannot-create-workflow-data","The provided EditorViewModel does not have an associated view");const l=await(0,S.QZ)(s,i.layer);return new x((0,P.A)((0,P.A)({},x._makeConstructorProps(e)),{},{layerView:l,sketchOptions:r,snappingManager:o}))}};(0,a._)([(0,y.MZ)()],R.prototype,"layerView",void 0),(0,a._)([(0,y.MZ)({constructOnly:!0})],R.prototype,"sketchOptions",void 0),(0,a._)([(0,y.MZ)()],R.prototype,"snappingManager",void 0),R=x=(0,a._)([(0,v.$)("esri.widgets.Editor.UpdateFeatureWorkflowData")],R);const j=R;var G,Q=i(87102);const z={exit:Symbol()};let $=G=class extends I.default{constructor(e){super(e),this._highlightHelper=null,this.fullFeature=null,this.type="update-table-record"}initialize(){const{data:e}=this,{edits:t}=e,{view:i}=e.viewModel,o=t.feature;i&&(this._highlightHelper=new m.A({view:i,highlightName:b.n4}),this.addHandles((0,s.hA)((()=>{var e;return null===(e=this._highlightHelper)||void 0===e?void 0:e.removeAll()}))));const a=new AbortController;this.addHandles((0,s.rE)(a)),this._updatingHandles.addPromise((0,S.mU)(o,e.viewModel.view.spatialReference,a.signal).then((e=>{(0,u.isAborted)(a)||(this._onFullFeatureLoaded(e),this._initializeFeatureFormViewModel())}),(e=>this.cancel({force:!0,error:new n.default("editor:failed-to-fetch-full-feature","Failed to retrieve all information for this feature. The update cannot proceed.",{detail:{error:e}})}))))}get editorItem(){return this.data.editorItem}get featureFormViewModel(){return this._featureFormViewModel}get hasPendingEdits(){return this.data.edits.modified}get layer(){return this.data.editorItem.layer}get parent(){return this.data.parent}get parentLayer(){var e;return null===(e=this.parent)||void 0===e?void 0:e.data.editorItem.layer}get shouldShowAttachments(){return this.editorItem.capabilities.attachments.enabled}get shouldAllowAttachmentEditing(){return this.editorItem.capabilities.update.attachments.enabled}get reliesOnOwnerAdminPrivileges(){const e=this.editorItem.capabilities;return e.update.reliesOnOwnerAdminPrivileges||e.delete.reliesOnOwnerAdminPrivileges}async deleteAndCommit(){return this.data.edits.stageDelete(),this.commit()}async enter(){this._configureAttachmentsViewModel()}exit(e){this.removeHandles(z.exit)}async start(){return await super.start(),null}_configureAttachmentsViewModel(){const{data:e,fullFeature:t}=this,{attachmentsCapabilities:i,viewModel:o}=e,{attachmentsViewModel:a}=o;a.set({capabilities:i,graphic:t,filesEnabled:!1,mode:"view"}),this.addHandles([(0,s.hA)((()=>a.fileInfos.removeAll())),(0,p.watch)((()=>a.mode),(e=>{switch(e){case"add":this.go("adding-attachment");break;case"edit":this.go("editing-attachment")}}))],z.exit)}_initializeFeatureFormViewModel(){const{association:e,edits:t,formTemplate:i,viewModel:{view:o}}=this.data,a=this._featureFormViewModel=new Q.default({activeAssociation:e,arcadeEditType:"UPDATE",feature:this.fullFeature,formTemplate:i,highlightHelper:this._highlightHelper,map:null===o||void 0===o?void 0:o.map,spatialReference:o.spatialReference,timeZone:null===o||void 0===o?void 0:o.timeZone});a.callbacks=(0,P.A)((0,P.A)({},this.data.featureFormCallbacks),{},{showAllRelatedRecords:e=>a.relationshipId=e.relationshipId,viewAssociatedLayers:e=>a.associationId=e.associationId,viewAssociatedFeatures:e=>a.associatedLayer=e.associatedLayer});const{initialFeature:r}=t;r&&a.overrideInitialFeature(r),this.addHandles([a.on("value-change",(()=>{t.updateAttributes(a.getValues()),this.fullFeature.attributes=t.feature.attributes})),(0,p.watch)((()=>null===o||void 0===o?void 0:o.timeZone),(e=>a.timeZone=e))])}_onFullFeatureLoaded(e){this.fullFeature=e;const{edits:t}=this.data;t.updateAttributes(e.attributes),t.trackChanges()}static async create(e){const t=new G({data:await D.create(e),onCommit:this._onCommitFactory(e.applyEdits)});return t._set("steps",this._createWorkflowSteps(t)),t}static _createWorkflowSteps(e){const{attachmentsViewModel:t}=e.data.viewModel;return[{id:"editing-attributes",async setUp(){},async tearDown(){}},{id:"adding-attachment",async setUp(){},async tearDown(){t.mode="view"}},{id:"editing-attachment",async setUp(){},async tearDown(){t.mode="view"}}]}};$._onCommitFactory=e=>async t=>{const{edits:i}=t,{feature:o}=i;if(!o)return;const a=o.sourceLayer,r=o.clone();if(!i.attributesModified||i.stagedForDelete){const e=a.objectIdField;if(r.attributes={[e]:o.getAttribute(e)},"scene"===a.type&&null!=a.infoFor3D){var n;const e=null===(n=a.associatedLayer)||void 0===n?void 0:n.globalIdField;null!=e&&r.setAttribute(e,o.getAttribute(e))}}i.geometryModified&&!i.stagedForDelete||(r.geometry=null);const s=i.stagedForDelete?"deleteFeatures":"updateFeatures";await e(a,{[s]:[r]})},(0,a._)([(0,y.MZ)()],$.prototype,"_featureFormViewModel",void 0),(0,a._)([(0,y.MZ)()],$.prototype,"editorItem",null),(0,a._)([(0,y.MZ)()],$.prototype,"featureFormViewModel",null),(0,a._)([(0,y.MZ)()],$.prototype,"fullFeature",void 0),(0,a._)([(0,y.MZ)()],$.prototype,"hasPendingEdits",null),(0,a._)([(0,y.MZ)()],$.prototype,"layer",null),(0,a._)([(0,y.MZ)()],$.prototype,"parent",null),(0,a._)([(0,y.MZ)()],$.prototype,"parentLayer",null),(0,a._)([(0,y.MZ)()],$.prototype,"shouldShowAttachments",null),(0,a._)([(0,y.MZ)()],$.prototype,"shouldAllowAttachmentEditing",null),(0,a._)([(0,y.MZ)()],$.prototype,"reliesOnOwnerAdminPrivileges",null),$=G=(0,a._)([(0,v.$)("esri.widgets.Editor.UpdateRecordWorkflow")],$);var B,J=i(81257);const K=(0,P.A)((0,P.A)({},z),{},{highlights:Symbol(),sketchGraphics:Symbol(),sketchViewModel:Symbol(),waitingForTool:Symbol()});let X=B=class extends ${constructor(e){super(e),this.type="update-feature",this._layerViewEditSession=null,this._sketchGraphicClone=null,this._sketchViewModel=null,this._webStyleCache=new Map}destroy(){var e;null===(e=this._layerViewEditSession)||void 0===e||e.rollback()}async commit(){this.removeHandles(K.sketchGraphics);try{const e=this.data.edits.stagedForDelete;await super.commit();const t=this._layerViewEditSession;e?null===t||void 0===t||t.rollback():null===t||void 0===t||t.commit()}catch(e){throw await this._configureSketchViewModel(),new n.default("editor-workflow:failed-to-commit","An error occurred when sending the updates to the service",{error:e})}}async start(){return await super.start(),await this._initializeSketchViewModel()}_initializeFeatureFormViewModel(){super._initializeFeatureFormViewModel(),this.addHandles([this._featureFormViewModel.on("value-change",(e=>{var t;null===(t=this._layerViewEditSession)||void 0===t||t.setAttribute(e.fieldName,e.value)})),(0,p.watch)((()=>{var e;return null===(e=this._featureFormViewModel.feature)||void 0===e?void 0:e.sourceLayer}),(e=>this._sketchGraphicClone.sourceLayer=e))])}_configureHighlight(){const{edits:e,layerView:t}=this.data;(0,H.Of)(t)&&this.addHandles(t.highlight(e.feature),K.highlights)}async _configureSketchViewModel(){const e=this._sketchViewModel;if(!e)return;const{data:t,_featureFormViewModel:i,_sketchGraphicClone:o}=this,{edits:a,viewModel:r}=t,n=a.feature,{view:s}=r,l=(0,S.EO)(n),d=await(0,S.vM)({feature:n,featureClone:o,visualVariableAttributes:l,sketchViewModel:e,view:s,onUpdate:(e,t)=>{let{geometry:o,attributes:r}=e;if(a.updateAttributes(r),a.updateGeometry(o),i.feature&&(i.feature.geometry=o),null!=l.rotation){const{field:e}=l.rotation;i.setValue(e,r[e])}if(null!=l.size){const{field:e}=l.size;i.setValue(e,r[e])}("undo"===t.type||"redo"===t.type||"update"===t.type&&null!=t.toolEventInfo&&(0,S.Ks)(t.toolEventInfo.type))&&i.notifyFeatureGeometryChanged()},addUpdatingPromise:e=>{this._updatingHandles.addPromise(e)},addHandle:e=>{this.addHandles(e,K.waitingForTool)},webStyleCache:this._webStyleCache});this.addHandles(d,K.sketchGraphics),e.addHandles(d)}async _initializeSketchViewModel(){const{data:e,_sketchGraphicClone:t}=this,i=e.edits.feature,{capabilities:o,layer:a}=e.editorItem,{view:r}=e.viewModel;if(this.removeHandles([K.highlights,K.sketchGraphics,K.sketchViewModel,K.waitingForTool]),!o.update.geometry||"3d"===(null===r||void 0===r?void 0:r.type)&&(0,q.wz)(a.elevationInfo))return{enter:async()=>{this.hasHandles(K.highlights)||this._configureHighlight()},exit:()=>this.removeHandles([K.highlights])};const n=new L.default({elevationInfo:a.elevationInfo,internal:!0,listMode:"hide"}),l=new J.default({allowDeleteKey:!1,layer:n,sketchOptions:e.sketchOptions,snappingManager:e.snappingManager,updateOnGraphicClick:!1,view:r});return this._sketchViewModel=l,null!==r&&void 0!==r&&r.map.add(n),this.addHandles((0,s.hA)((()=>{null!==r&&void 0!==r&&r.destroyed||null!==r&&void 0!==r&&r.map.remove(n),n.destroy(),this._sketchViewModel=(0,d.pR)(l)})),K.sketchViewModel),await(0,S.FC)(t,this._webStyleCache,"2d"===(null===r||void 0===r?void 0:r.type)?r.scale:null),this.addHandles([await(0,S.z7)(l,i,t)]),{enter:async()=>{this.hasHandles(K.sketchGraphics)||await this._configureSketchViewModel()},exit:()=>this.removeHandles([K.sketchGraphics]),viewModel:l}}_onFullFeatureLoaded(e){super._onFullFeatureLoaded(e);const t=this._sketchGraphicClone=(0,S.ON)(e),{edits:i,layerView:o}=this.data;i.updateGeometry(e.geometry),i.trackChanges(),(0,S.nv)(o)&&(this._layerViewEditSession=o.createInteractiveEditSession(t))}static async create(e){const t=new B({data:await j.create(e),onCommit:this._onCommitFactory(e.applyEdits)});return t._set("steps",this._createWorkflowSteps(t)),t}get test(){}};(0,a._)([(0,y.MZ)()],X.prototype,"_layerViewEditSession",void 0),(0,a._)([(0,y.MZ)()],X.prototype,"_sketchGraphicClone",void 0),(0,a._)([(0,y.MZ)()],X.prototype,"_sketchViewModel",void 0),X=B=(0,a._)([(0,v.$)("esri.widgets.Editor.UpdateFeatureWorkflow")],X);var Y,ee=i(62128),te=i(9912);const ie="esri.widgets.Editor.UpdateWorkflow";let oe=Y=class extends I.default{constructor(e){super(e),this._workflowStack=new c.A(h.HV),this._sketchStack=new c.A(h.HV),this.data=void 0,this.type="update"}destroy(){this._drainWorkflowStack((e=>e.cancel({force:!0})))}get activeEditorItem(){var e,t;return null!==(e=null===(t=this.activeWorkflow)||void 0===t?void 0:t.data.editorItem)&&void 0!==e?e:void 0}get activeFeatureFormViewModel(){var e;return null===(e=this.activeWorkflow)||void 0===e?void 0:e.featureFormViewModel}get activeUtilityNetworkAssociationAddAssociationViewModel(){var e;return"add-association"===(null===(e=this.activeWorkflow)||void 0===e?void 0:e.type)?this.activeWorkflow.utilityNetworkAssociationAddAssociationViewModel:null}get activeSketchViewModel(){var e;return null===(e=this._sketchStack.peek())||void 0===e?void 0:e.viewModel}get canDeleteAssociation(){var e;const{activeFeatureFormViewModel:t}=this;if(!this.activeWorkflow||null===(e=this.data.viewModel.view)||void 0===e||!e.map||!t)return!1;const{activeAssociation:i,feature:o}=t;return!(!i||null===o||void 0===o||!o.sourceLayer||!(0,f.yZ)(null===o||void 0===o?void 0:o.sourceLayer)&&!(0,f.Sv)(null===o||void 0===o?void 0:o.sourceLayer))}get activeWorkflow(){return this._workflowStack.last()}get updating(){var e;return this._updatingHandles.updating||!(null===(e=this.activeWorkflow)||void 0===e||!e.updating)}get hasPreviousStep(){var e;const t=null===(e=this.activeWorkflow)||void 0===e?void 0:e.featureFormViewModel;return this._stepIndex>0||this.nestedWorkflowCount>1||null!=(null===t||void 0===t?void 0:t.relationshipId)||"view"!==this.data.viewModel.attachmentsViewModel.mode||null!=(null===t||void 0===t?void 0:t.associationId)||null!=(null===t||void 0===t?void 0:t.associatedLayer)}get hasUpdatableCandidates(){const{candidates:e,viewModel:t}=this.data;return e.some((e=>{var i;let{layer:o}=e;return null===(i=t.findEditorItemForLayer(o))||void 0===i?void 0:i.supportsUpdateWorkflow}))}get nestedWorkflowCount(){return this._workflowStack.length}get shouldShowAttachments(){var e;return!(null===(e=this.activeEditorItem)||void 0===e||!e.capabilities.attachments.enabled)}get shouldAllowAttachmentEditing(){var e;return!(null===(e=this.activeEditorItem)||void 0===e||!e.capabilities.update.attachments.enabled)}get hasPendingEdits(){return Array.from(this._workflowStack).some((e=>e.hasPendingEdits))}get helpMessage(){var e;return null!==(e=this.activeWorkflow)&&void 0!==e&&e.helpMessage?this.activeWorkflow.helpMessage:"awaiting-feature-to-update"===this.stepId?"select":void 0}get reliesOnOwnerAdminPrivileges(){var e,t;return null!==(e=null===(t=this.activeWorkflow)||void 0===t?void 0:t.reliesOnOwnerAdminPrivileges)&&void 0!==e&&e}get hasInvalidFormTemplate(){var e;return!(null===(e=this.activeEditorItem)||void 0===e||!e.hasInvalidFormTemplate)}async back(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:()=>Promise.resolve(!0);const{activeWorkflow:t}=this,i=null===t||void 0===t?void 0:t.featureFormViewModel;if(null!==i&&void 0!==i&&i.activeRelationshipInput){const e=i.activeRelationshipInput;if(e.activeCategory)return void(e.activeCategory=null);if(null!=i.relationshipId)return void(i.relationshipId=null);if(e.showAllEnabled)return void(e.showAllEnabled=!1)}if("add-association"===(null===t||void 0===t?void 0:t.type)){const{activeUtilityNetworkAssociationAddAssociationViewModel:e}=this;if(null!==e&&void 0!==e&&e.filterOptionsVisible)return void(e.filterOptionsVisible=!1)}if(null==(null===i||void 0===i?void 0:i.associatedLayer))if(null==(null===i||void 0===i?void 0:i.associationId))if("create-features"===(null===t||void 0===t?void 0:t.type)&&t.hasPreviousStep)await t.previous({cancelCurrentStep:!0});else if(t){if(t.hasPendingEdits&&!await e())return;t.hasPreviousStep?await t.previous({cancelCurrentStep:!0}):await this.cancelActiveWorkflow({force:!0})}else this.hasPreviousStep?await this.previous({cancelCurrentStep:!0}):await this.cancel({force:!0});else i.associationId=null;else i.associatedLayer=null}async cancelActiveWorkflow(e){var t;await(null===(t=this.activeWorkflow)||void 0===t?void 0:t.cancel(e)),await this._popWorkflow()}async commit(){await this._drainWorkflowStack((e=>e.commit())),await super.commit()}static create(e){var t;const{viewModel:i,snappingManager:o,startAt:a,addAttachmentsCallback:r,applyEditsCallback:n,applyEditsFeatureServiceCallback:s}=e,l=null!==(t=e.sketchOptions)&&void 0!==t?t:new k.A,d=new Y({data:new ee.default({addAttachmentsCallback:r,applyEditsCallback:n,applyEditsFeatureServiceCallback:s,sketchOptions:l,snappingManager:o,viewModel:i}),onCommit:async()=>{}});return d._set("steps",this._createWorkflowSteps(d,a)),d}async save(){var e;this.nestedWorkflowCount>1?(await(null===(e=this.activeWorkflow)||void 0===e?void 0:e.commit()),await this._popWorkflow()):await this.commit()}async startCreatingRelatedRecord(e){try{const t=await this._createNestedCreateFeaturesWorkflow(e);await this._pushWorkflow(t)}catch(t){throw new n.default("editor:unable-to-start-creating","Could not begin updating the provided feature or table record.",{error:t})}}async startUpdating(e,t){try{const i=await this._createNestedUpdateWorkflow(e,t);await this._pushWorkflow(i)}catch(i){throw new n.default("editor:unable-to-start-updating","Could not begin updating the provided feature or table record.",{error:i})}}async startAddAssociation(e,t,i){try{const o=await this._createNestedAddAssociationWorkflow(e,t,i);await this._pushWorkflow(o)}catch(o){throw new n.default("editor:unable-to-start-updating","Could not begin updating the provided feature or table record.",{error:o})}}async deleteActiveFeature(){const{activeWorkflow:e}=this;if(!e)throw new n.default("editor:nothing-to-delete","There is no feature to delete");ne(e)?await e.deleteAndCommit():await e.cancel(),1===this.nestedWorkflowCount?await this.reset():(await this._popWorkflow(),await this._returnToPageWithContent())}async deleteActiveAssociation(){if(!this.canDeleteAssociation)throw new n.default("editor:nothing-to-delete","There is no association to delete");await this._deleteActiveAssociation(),await this._popWorkflow(),await this._returnToPageWithContent()}async cancelAll(){await this._drainWorkflowStack((e=>e.cancel({force:!0})))}async _deleteActiveAssociation(){var e,t;const{activeFeatureFormViewModel:i,data:o}=this,{activeAssociation:a,feature:r}=i,{applyEditsFeatureServiceCallback:s,viewModel:l}=o,{sourceLayer:d}=r,u=(0,f.Sv)(d)&&d.parent?d.parent:d,c=null===(e=(0,g.createFeatureServices)([u]).values().next().value)||void 0===e?void 0:e.featureService;if(!c)throw new n.default("editor:failed-to-delete-association","Could not retrieve feature service needed to delete association");await(null===c||void 0===c?void 0:c.load());const p=l.view.map,h=(0,te.findUtilityNetwork)(p,u);await(null===h||void 0===h?void 0:h.networkSystemLayers.loadAssociationsTable());const y=null===h||void 0===h?void 0:h.generateDeleteAssociations([a]);if(!y)throw new n.default("editor:failed-to-delete-association","Could not create payload needed to delete association");const v=null!==(t=null===h||void 0===h?void 0:h.gdbVersion)&&void 0!==t?t:void 0;await s(c,[y],{gdbVersion:v,globalIdUsed:!0})}async _returnToPageWithContent(){var e;const{activeFeatureFormViewModel:t}=this;if(null===t||void 0===t||!t.activeAssociationInput)return;const{activeAssociationInput:i,associationId:o}=t;await i.refresh(),i.associatedLayer&&!(null!==(e=i.associatedFeatures)&&void 0!==e&&e.length)&&(t.associatedLayer=null),null==o||i.associatedFeatureInfos.size||(t.associationId=null)}async _createNestedCreateFeaturesWorkflow(e){var t,i;const{relatedLayer:o}=e,{addAttachmentsCallback:a,applyEditsCallback:r,applyEditsFeatureServiceCallback:s,sketchOptions:l,snappingManager:d,viewModel:u}=this.data;if(!(0,w.S)(o))throw new n.default("editor:unsupported-layer","Editing is not supported on the provided layer");const c=this._getCreationInfoForNestedCreateFeaturesWorkflow(e),p=c.template||c.initialFeature?"creating-features":"awaiting-feature-creation-info",h="create-features"!==(null===(t=this.activeWorkflow)||void 0===t?void 0:t.type)&&"add-association"!==(null===(i=this.activeWorkflow)||void 0===i?void 0:i.type)?this.activeWorkflow:void 0;return N.default.create({addAttachmentsCallback:a,applyEditsCallback:r,applyEditsFeatureServiceCallback:s,creationInfo:c,isNested:!0,parent:h,sketchOptions:l,snappingManager:d,startAt:p,viewModel:u})}_getCreationInfoForNestedCreateFeaturesWorkflow(e){const{relatedLayer:t}=e;if(!(0,w.S)(t)||(0,f.F2)(t))throw new n.default("editor:unsupported-layer","Editing is not supported on the provided layer");const{viewModel:i}=this.data,o={layer:t,maxFeatures:1},a=this._makeRelatedRecordAttributes(e),s=i.getTemplatesForLayer(t);return(null===s||void 0===s?void 0:s.length)>0?(o.attributeOverrides=a,1===s.length&&(o.template=s[0])):o.initialFeature=new r.default({sourceLayer:t,attributes:a}),o}async _createNestedUpdateWorkflow(e,t){var i,o;const a=(0,f.bI)(e.sourceLayer)?$:X,{applyEditsCallback:r,applyEditsFeatureServiceCallback:n,sketchOptions:s,snappingManager:l,viewModel:d}=this.data,u="create-features"!==(null===(i=this.activeWorkflow)||void 0===i?void 0:i.type)&&"add-association"!==(null===(o=this.activeWorkflow)||void 0===o?void 0:o.type)?this.activeWorkflow:void 0,c=await a.create({association:t,feature:e,parent:u,sketchOptions:s,snappingManager:l,viewModel:d,applyEdits:r,applyEditsFeatureService:n,featureFormCallbacks:{addRelatedRecord:async e=>await this.startCreatingRelatedRecord(e),editRelatedRecord:async e=>{let{relatedFeature:t}=e;return await this.startUpdating(t)},selectAssociatedFeature:async e=>{let{feature:t,association:i}=e;return await this.startUpdating(t,i)},addAssociation:async e=>await this.startAddAssociation(e.feature,e.utilityNetwork,e.associationType)}});return await(0,p.whenOnce)((()=>!c.updating)),c}async _createNestedAddAssociationWorkflow(e,t,i){var o,a,r;const n=V,{applyEditsCallback:s,applyEditsFeatureServiceCallback:l,viewModel:d}=this.data,u="create-features"!==(null===(o=this.activeWorkflow)||void 0===o?void 0:o.type)&&"add-association"!==(null===(a=this.activeWorkflow)||void 0===a?void 0:a.type)?this.activeWorkflow:void 0,c=null===(r=this.activeFeatureFormViewModel)||void 0===r?void 0:r.activeAssociationInput,h=await n.create({utilityNetwork:t,associationType:i,feature:e,parent:u,viewModel:d,associationInput:c,applyEdits:s,applyEditsFeatureService:l});return await(0,p.whenOnce)((()=>!h.updating)),h}async _drainWorkflowStack(e){const t=this._workflowStack,i=[];for(;t.length>0;){const o=t.pop();this._sketchStack.pop();const a=e(o).then((()=>o.destroy()));this._updatingHandles.addPromise(a),i.push(a)}await Promise.all(i)}_makeRelatedRecordAttributes(e){var t,i;const{parentFeature:o,relatedLayer:a,relationshipId:r}=e;if(!(0,te.isGraphicForRelatableFeatureSupportedLayer)(o))return;const n=null===(t=a.relationships)||void 0===t?void 0:t.find((e=>e.id===r));if(!n)return void re("relationship-not-found","Could not begin creating a related record because the relationship specified could not be found on the destination layer.");if("origin"===n.role)return void re("unsupported-role","Creating new related records in the 'origin' table of a relationship is not yet supported");const s=o.sourceLayer;n.relatedTableId!==s.layerId&&re("invalid-argument-combination","The given parent feature does not belong to the relationship designated by the given relationship ID.");const l=null===(i=s.relationships)||void 0===i?void 0:i.find((e=>e.id===r));if(!l)return void re("relationship-not-found","Could not begin creating a related record because the relationship specified could not be found on the origin layer.");const d=ae(s,l),u=o.getAttribute(d);u||re("no-key-on-origin-feature","The given parent feature does not have a value for the relationship's origin primary key field.");const c=ae(a,n);return{[c]:u}}async _popWorkflow(){var e;null!==(e=this._workflowStack.pop())&&void 0!==e&&e.destroy(),this._sketchStack.pop();const t=await this._reconcileWorkflowStack();if(t.failureCount>0)throw new n.default("editor:next-workflow-failed","Popped the top workflow, but the next workflow in the stack failed to activate",t)}async _pushWorkflow(e){var t;const i=this._workflowRequiresSketchViewModel(e);null===(t=this.activeWorkflow)||void 0===t||t.exit({removeSketchHandles:i});const o=this._sketchStack,a=await(null===e||void 0===e?void 0:e.start()),r=o.peek();a?(null!==r&&void 0!==r&&r.exit(),o.push(a)):o.push(this._cloneSketchController(r)),this._workflowStack.push(e);const s=await this._reconcileWorkflowStack();if(s.failureCount>0)throw new n.default("editor:failed-to-start-updating-feature","Failed to enter the provided workflow.",s)}async _reconcileWorkflowStack(){const e=this._workflowStack,t=this._sketchStack;try{var i;const o=e.peek();return await(null===o||void 0===o?void 0:o.enter()),await(null===(i=t.peek())||void 0===i?void 0:i.enter()),{activeWorkflow:o,failureCount:0}}catch(M){e.pop().destroy(),t.pop();const{activeWorkflow:o,failureCount:a}=await this._reconcileWorkflowStack();return{activeWorkflow:o,failureCount:a+1}}}_cloneSketchController(e){var t,i;return{enter:null!==(t=null===e||void 0===e?void 0:e.enter)&&void 0!==t?t:async()=>{},exit:null!==(i=null===e||void 0===e?void 0:e.exit)&&void 0!==i?i:async()=>{},viewModel:null===e||void 0===e?void 0:e.viewModel}}_workflowRequiresSketchViewModel(e){var t;const{type:i}=e;return"update-feature"===i||"create-features"===i&&!(0,f.bI)(null===(t=e.data.creationInfo)||void 0===t?void 0:t.layer)}static _createWorkflowSteps(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"awaiting-feature-to-update";const{data:i}=e;return(0,S.z4)(["awaiting-feature-to-update","awaiting-update-feature-candidate","editing-existing-feature","adding-attachment","editing-attachment"],t,{"awaiting-feature-to-update":()=>({id:"awaiting-feature-to-update",async setUp(){const{spinnerViewModel:t}=i.viewModel,o=i.viewModel.view;o.activeTool=null;let a=null;e.addHandles((0,s.hA)((()=>{a=(0,d.DC)(a)})),this.id),i.rootFeature=null,i.candidates=[];const r=o.on("immediate-click",(async r=>{const n=(0,u.createResolver)();e._updatingHandles.addPromise(n.promise);try{var s;t.location=r.mapPoint,t.visible=!0,null===(s=a)||void 0===s||s.abort();const{editorItems:n}=i.viewModel;a=new AbortController;const l=await r.async((()=>new Promise(((e,t)=>{var i,s;(0,u.onAbort)(null===(i=a)||void 0===i?void 0:i.signal,(()=>t((0,u.createAbortError)()))),e((0,S.Zs)(n,o,r,null===(s=a)||void 0===s?void 0:s.signal))}))));if((0,u.throwIfAborted)(a),i.candidates=l.filter((e=>"fulfilled"===e.status)).flatMap((e=>e.value)).filter((e=>!e.isAggregate)),t.visible=1===i.candidates.length,0===i.candidates.length)return;r.stopPropagation(),1===i.candidates.length?(i.rootFeature=i.candidates[0],e.go("editing-existing-feature").catch((()=>{})).then((()=>t.visible=!1))):e.next()}finally{n.resolve()}}),_.o.TOOL),n=(0,p.when)((()=>null!=o.activeTool),(()=>e.cancel({force:!0})),{once:!0});o.focus(),e.addHandles([r,n],this.id)},async tearDown(){0===i.candidates.length&&(i.viewModel.spinnerViewModel.visible=!1),e.removeHandles(this.id)}}),"awaiting-update-feature-candidate":()=>({id:"awaiting-update-feature-candidate",async setUp(){i.rootFeature=null;const{view:t}=i.viewModel;if(!t)return;const o=new m.A({view:t,highlightName:b.n4});e.addHandles([(0,p.watch)((()=>i.rootFeature),((e,t)=>{o.remove(t),o.add(e)}),p.sync),(0,s.hA)((()=>o.removeAll()))],this.id)},async tearDown(){e.removeHandles(this.id)}}),"editing-existing-feature":()=>({id:"editing-existing-feature",async setUp(){const{rootFeature:t,viewModel:i}=e.data;if(!t)throw new n.default("editor:no-feature-specified","Cannot setup the 'updating-existing-feature' step until the root feature is defined");await e.startUpdating(t),i.spinnerViewModel.visible=!1;const o=(0,u.debounce)((async()=>{await(0,p.whenOnce)((()=>!e.updating)),e.previous()}));e.addHandles([(0,p.watch)((()=>e.nestedWorkflowCount),((e,t)=>{0===e&&0!==t&&o()}),p.sync)],this.id)},async tearDown(){await e.cancelAll(),e.removeHandles(this.id)}}),"adding-attachment":()=>({id:"adding-attachment",parent:"editing-existing-feature",async setUp(){},async tearDown(){i.viewModel.attachmentsViewModel.mode="view"}}),"editing-attachment":()=>({id:"editing-attachment",parent:"editing-existing-feature",async setUp(){},async tearDown(){i.viewModel.attachmentsViewModel.mode="view"}})})}};function ae(e,t){var i,o;let{keyField:a}=t;return null!==(i=null===(o=e.getField(a))||void 0===o?void 0:o.name)&&void 0!==i?i:a}(0,a._)([(0,y.MZ)()],oe.prototype,"activeEditorItem",null),(0,a._)([(0,y.MZ)()],oe.prototype,"activeFeatureFormViewModel",null),(0,a._)([(0,y.MZ)()],oe.prototype,"activeUtilityNetworkAssociationAddAssociationViewModel",null),(0,a._)([(0,y.MZ)()],oe.prototype,"activeSketchViewModel",null),(0,a._)([(0,y.MZ)()],oe.prototype,"canDeleteAssociation",null),(0,a._)([(0,y.MZ)()],oe.prototype,"activeWorkflow",null),(0,a._)([(0,y.MZ)()],oe.prototype,"updating",null),(0,a._)([(0,y.MZ)()],oe.prototype,"data",void 0),(0,a._)([(0,y.MZ)()],oe.prototype,"hasPreviousStep",null),(0,a._)([(0,y.MZ)()],oe.prototype,"hasUpdatableCandidates",null),(0,a._)([(0,y.MZ)()],oe.prototype,"nestedWorkflowCount",null),(0,a._)([(0,y.MZ)()],oe.prototype,"shouldShowAttachments",null),(0,a._)([(0,y.MZ)()],oe.prototype,"shouldAllowAttachmentEditing",null),(0,a._)([(0,y.MZ)()],oe.prototype,"hasPendingEdits",null),(0,a._)([(0,y.MZ)()],oe.prototype,"helpMessage",null),(0,a._)([(0,y.MZ)()],oe.prototype,"reliesOnOwnerAdminPrivileges",null),(0,a._)([(0,y.MZ)()],oe.prototype,"hasInvalidFormTemplate",null),oe=Y=(0,a._)([(0,v.$)(ie)],oe);const re=(e,t)=>l.A.getLogger(ie).warn("editor:".concat(e),t,"The create operation will be allowed to proceed, but the resulting feature may not be related to the given parent feature."),ne=e=>!!e&&/update-/.test(e.type),se=oe}}]);
//# sourceMappingURL=96500.314c5cb7.chunk.js.map