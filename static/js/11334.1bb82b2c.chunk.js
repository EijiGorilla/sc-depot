"use strict";(self.webpackChunksc_depot=self.webpackChunksc_depot||[]).push([[11334],{11334:(e,t,i)=>{i.d(t,{default:()=>v});var a=i(39356),o=i(18690),r=i(50346),n=i(10851),l=i(19247),s=i(9624),c=i(56623),u=i(86017),d=i(19562);class v{constructor(e){this.viewModel=e,this._updateBestFeatureFootprintElevation=!1,this.createFootprints=async e=>{const{coverageFrustums:t,currentBestFeature:i,isAdditionalCoverageVisible:l,view:v}=this.viewModel,p=t.filter(o.Ru);for(const o of p){let t=o.clone();if(!v.spatialReference.equals(t.spatialReference)){const{components:i,spatialReference:a,origin:o,vertexAttributes:l,vertexSpace:d}=t;if("local"===d.type){const i=await(0,s.projectWithZConversion)(o,v.spatialReference,e);(0,r.throwIfAborted)(e),t.centerAt(i)}else{const o=l.position,s=Float64Array.from(await(0,u.PT)([...o],a.clone(),v.spatialReference.clone(),e));(0,r.throwIfAborted)(e),t=new n.default({vertexAttributes:new c.H({position:s}),components:i,spatialReference:v.spatialReference.clone()})}}o.imageID===i.attributes.objectId?(this.viewModel.bestFeatureFootprint=new a.default({attributes:{imageID:o.imageID},geometry:t,symbol:d.Xg.clone(),visible:!1}),this._updateBestFeatureFootprintElevation=!0):this.viewModel.additionalFootprints.push(new a.default({attributes:{imageID:o.imageID},geometry:t,symbol:d.Mi.clone(),visible:l}))}},this.updateFootprint=async(e,t)=>{const{bestFeatureFootprint:i,currentBestFeature:n,activeViewer:c,footprintExtent:v,view:p}=this.viewModel,f=null===c||void 0===c?void 0:c.imageSize;if(!(n&&null!==i&&void 0!==i&&i.geometry&&f&&v))return void this.viewModel.updateCurrentCoveragePolygon(null);const{attributes:{cameraHeight:w,location:h,cameraPitch:m,horizontalFieldOfView:g,verticalFieldOfView:b,cameraRoll:y},elevationSample:F}=n;F&&this._updateBestFeatureFootprintElevation&&(this.updateGroundElevation([i],F),this._updateBestFeatureFootprintElevation=!1);const R=h.toArray(),{vertexAttributes:{position:M},spatialReference:A}=i.geometry,C=await async function(e,t,i,a){return Float64Array.from((await Promise.all(e.reduce(((e,t,i)=>{var a;const o=Math.floor(i/3);return e[o]=null!==(a=e[o])&&void 0!==a?a:[],e[o].push(t),e}),new Array).map((async e=>(await(0,s.projectWithZConversion)(new l.default(e,t),i,a)).toArray())))).flat())}(M,A,h.spatialReference),I=await this.viewModel.getMapPoint(e,{feature:n,mode:"default",imageSize:f});(0,r.throwIfAborted)(t);let V=I.filter(o.Ru);if(!V.length)return;V[0].spatialReference.equals(h.spatialReference)||(V=await Promise.all(V.map((async e=>{const i=await(0,s.projectWithZConversion)(e,h.spatialReference,t);return(0,r.throwIfAborted)(t),i}))));const P=await(0,u.WD)(e.map((e=>{let{x:t,y:i}=e;return[t,i]})),V.map((e=>e.toArray())),{cameraHeight:w,cameraLocation:R,cameraPitch:m,frustumVertices:C,horizontalFieldOfView:g,imageHeight:f[1],imageWidth:f[0],inSRS:{wkid:h.spatialReference.wkid},outSRS:{wkid:p.spatialReference.wkid},verticalFieldOfView:b,cameraRoll:null!==y&&void 0!==y?y:0,options:t});this.viewModel.updateCurrentCoveragePolygon(new a.default({attributes:{imageID:n.attributes.objectId},geometry:P,symbol:d.Xg.clone(),visible:this.viewModel.currentCoverageVisible}))},this.updateFootprintPanorama=async(e,t)=>{var i;await(0,r.waitTick)(t);const{horizontalFieldOfView:o,pitch:n,verticalFieldOfView:l,yaw:s}=e,c=null===(i=this.viewModel.currentBestFeature)||void 0===i?void 0:i.clone();if(!c)return;const{attributes:v}=c;v.orientedImageryType=null,v.cameraHeading=(s+v.cameraHeading)%360,v.cameraPitch=n,v.horizontalFieldOfView=o,v.verticalFieldOfView=l,v.cameraRoll=0;const{frustum:p}=(0,u.ns)(v);p?this.viewModel.updateCurrentCoveragePolygon(new a.default({attributes:{imageID:v.objectId},geometry:p,symbol:d.Xg.clone(),visible:this.viewModel.currentCoverageVisible})):this.viewModel.updateCurrentCoveragePolygon(null)}}updateGroundElevation(e,t){const{geometry:i}=this.viewModel.currentBestFeature,a=t.queryElevation(i);e.forEach((e=>{var t,i;const{geometry:o}=e;switch(null===o||void 0===o?void 0:o.type){case"mesh":{const{vertexAttributes:{position:e}}=o,t=Math.floor(e.length/3);for(let i=0;i<t;i+=1){var r;e[3*i+2]+=null!==(r=null===a||void 0===a?void 0:a.z)&&void 0!==r?r:0}break}case"point":o.z=(null!==(t=o.z)&&void 0!==t?t:0)+(null!==(i=null===a||void 0===a?void 0:a.z)&&void 0!==i?i:0)}}))}}}}]);
//# sourceMappingURL=11334.1bb82b2c.chunk.js.map