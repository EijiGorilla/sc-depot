"use strict";(self.webpackChunksc_depot=self.webpackChunksc_depot||[]).push([[9912,87531,91039],{9912:(e,t,n)=>{n.r(t),n.d(t,{applyTextFormattingHTML:()=>K,createFieldInfoMap:()=>J,findRelatedLayer:()=>se,findUtilityNetwork:()=>ue,fixTokens:()=>O,formatAttributes:()=>X,formatEditInfo:()=>z,formatValueToFieldInfo:()=>V,getAllFieldInfos:()=>Y,getFieldInfo:()=>B,getFieldInfoLabel:()=>M,getFixedFieldName:()=>N,getFixedFieldNames:()=>Z,getHighlightKeyForFeature:()=>ye,getSourceLayer:()=>C,graphicCallback:()=>k,htmlEntities:()=>$,isAssociatedFeatureSupportedLayer:()=>Q,isExpressionField:()=>q,isFeatureSupportedLayer:()=>D,isGraphicForRelatableFeatureSupportedLayer:()=>H,isRelatableFeatureSupportedLayer:()=>P,isRelatableLayer:()=>R,isRelatedField:()=>ne,preLayerQueryCallback:()=>ae,preRequestCallback:()=>le,querySourceLayer:()=>ee,queryUpdatedFeature:()=>te,shouldOpenInNewTab:()=>T,substituteAttributes:()=>S,substituteFieldsInLinksAndAttributes:()=>j});var i=n(89379),o=n(81806),r=n(76460),a=n(88685),l=n(65256),s=n(50265),u=n(53430),c=n(31933),d=n(42633),y=n(98976),p=n(67478);const f=()=>r.A.getLogger("esri.widgets.Feature.support.featureUtils"),h=/href=(""|'')/gi,v=/(\{([^{\r\n]+)\})/g,m=/'/g,g=/^\s*expression\//i,b=/(\n)/gi,I=/[\u00A0-\u9999<>&]/gim,w=/href\s*=\s*(?:"([^"]+)"|'([^']+)')/gi,F=/^(?:mailto:|tel:)/,A="relationships/",_=(0,l.J2)("short-date-short-time");function C(e){var t;if(null!=e)return null!==(t=e.sourceLayer||e.layer)&&void 0!==t?t:void 0}async function k(e){let{type:t,value:n,event:i}=e;try{return"function"==typeof n?n(i):await n}catch(o){return void f().error("error",'An error occurred when calling the "'.concat(t,'" function'),{error:o,graphic:i.graphic,value:n})}}function T(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";if(e)return!F.test(e.trim().toLowerCase())}function q(e){return!!e&&g.test(e)}function M(e,t){const n=function(e,t){if(!t||!q(t)||!e)return;const n=t.replace(g,"").toLowerCase();return e.find((e=>{let{name:t}=e;return t.toLowerCase()===n}))}(t,null===e||void 0===e?void 0:e.fieldName);return n?n.title||null:e?e.label||e.fieldName:null}function N(e,t){const n=E(t,e);return n?n.name:e}function Z(e,t){return e&&e.map((e=>N(e,t)))}function E(e,t){var n;return e&&"function"==typeof e.getField&&t&&null!==(n=e.getField(t))&&void 0!==n?n:null}function L(e){return"".concat(e).trim()}function j(e){let{attributes:t,globalAttributes:n,layer:o,text:r,expressionAttributes:a,fieldInfoMap:l}=e;return r?S({formattedAttributes:n,template:U(r,(0,i.A)((0,i.A)((0,i.A)({},n),a),t),o),fieldInfoMap:l}):""}function S(e){let{formattedAttributes:t,template:n,fieldInfoMap:i}=e;return L(function(e){return e.replaceAll(h,"")}((0,a.HC)((0,a.HC)(n,(e=>function(e,t){const n=t.get(e.toLowerCase());return"{".concat((null===n||void 0===n?void 0:n.fieldName)||e,"}")}(e,i))),t)))}function x(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const n=(0,i.A)({},e);return Object.keys(n).forEach((e=>function(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const i=t[e];if("string"==typeof i){const o="%27",r=(n?encodeURIComponent(i):i).replaceAll(m,o);t[e]=r}}(e,n,t))),n}function O(e,t){return e.replaceAll(v,((e,n,i)=>{const o=E(t,i);return o?"{".concat(o.name,"}"):n}))}function U(e,t,n){const i=O(e,n);return i?i.replaceAll(w,((e,n,i)=>function(e,t,n){const i=(t=L(t))&&"{"!==t[0];return(0,a.HC)(e,x(n,i||!1))}(e,n||i,t))):i}function D(e){return null!=e&&"object"==typeof e&&"fieldsIndex"in e&&"geometryType"in e&&"getField"in e&&"load"in e&&"loaded"in e&&"objectIdField"in e&&"spatialReference"in e&&"type"in e&&("feature"===e.type||"scene"===e.type||"subtype-group"===e.type||"subtype-sublayer"===e.type||"sublayer"===e.type)&&"when"in e}function R(e){return null!=e&&"object"==typeof e&&"createQuery"in e&&"queryFeatureCount"in e&&"queryObjectIds"in e&&"queryRelatedFeatures"in e&&"queryRelatedFeaturesCount"in e&&"relationships"in e}function P(e){return D(e)&&R(e)}function Q(e){return!(!(e&&"object"==typeof e&&"createQuery"in e&&"getField"in e&&"queryFeatureCount"in e&&"queryFeatures"in e&&"queryObjectIds"in e&&"capabilities"in e&&"fields"in e&&"fieldsIndex"in e&&"type"in e)||"feature"!==e.type&&"subtype-group"!==e.type&&"subtype-sublayer"!==e.type&&"sublayer"!==e.type||!("when"in e))&&("subtype-sublayer"===e.type&&"parent"in e&&e.parent&&"object"==typeof e.parent?"globalIdField"in e.parent:"globalIdField"in e)}function H(e){return!!e&&"object"==typeof e&&"sourceLayer"in e&&P(e.sourceLayer)}function V(e,t){const{fieldInfos:n,fieldName:o,preventPlacesFormatting:r,layer:a,timeZone:l}=t,c=B(n,o),y=E(a,o);if(c&&!(0,u.isRasterPixelValueField)(o)){var p;const t=null===y||void 0===y?void 0:y.type,n=null===(p=c.format)||void 0===p?void 0:p.dateFormat;if("date"===t||"date-only"===t||"time-only"===t||"timestamp-offset"===t||n)return(0,d.i0)(e,{format:n,fieldType:t,timeZoneOptions:{layerTimeZone:a&&"preferredTimeZone"in a?a.preferredTimeZone:null,viewTimeZone:l,datesInUnknownTimezone:!(!a||!("datesInUnknownTimezone"in a))&&!!a.datesInUnknownTimezone}})}const f=null===c||void 0===c?void 0:c.format;return"string"==typeof e&&(0,u.isRasterPixelValueField)(o)&&f?function(e,t){return e=e.trim(),/\d{2}-\d{2}/.test(e)?e:e.includes(",")?G(e,",",", ",t):e.includes(";")?G(e,";","; ",t):e.includes(" ")?G(e," "," ",t):(0,s.ZV)(Number(e),(0,s.yx)(t))}(e,f):"string"==typeof(e=function(e,t){if("string"==typeof e&&t&&null==t.dateFormat&&(null!=t.places||null!=t.digitSeparator)){const t=Number(e);if(!isNaN(t))return t}return e}(e,f))||null==e||null==f?K(e):(0,s.ZV)(e,r?(0,i.A)((0,i.A)({},(0,s.yx)(f)),{},{minimumFractionDigits:0,maximumFractionDigits:20}):(0,s.yx)(f))}function G(e,t,n,i){return e.trim().split(t).map((e=>(0,s.ZV)(Number(e),(0,s.yx)(i)))).join(n)}function B(e,t){if(null!==e&&void 0!==e&&e.length&&t)return e.find((e=>{var n;return(null===(n=e.fieldName)||void 0===n?void 0:n.toLowerCase())===t.toLowerCase()}))}function z(e,t,n,o){const{creatorField:r,creationDateField:a,editorField:s,editDateField:u}=e;if(!t)return;const c=(0,p.hv)(o&&"preferredTimeZone"in o?o.preferredTimeZone:null,!(!o||!("datesInUnknownTimezone"in o))&&!!o.datesInUnknownTimezone,n,_,"date"),d=(0,i.A)((0,i.A)({},_),c),y=t[u];if("number"==typeof y){const e=t[s];return{type:"edit",date:(0,l.Yq)(y,d),user:e}}const f=t[a];if("number"==typeof f){const e=t[r];return{type:"create",date:(0,l.Yq)(f,d),user:e}}return null}function J(e,t){const n=new Map;if(!e)return n;for(const i of e){if(!i.fieldName)continue;const e=N(i.fieldName,t);i.fieldName=e,n.set(e.toLowerCase(),i)}return n}function Y(e){const t=[];if(!e)return t;const{fieldInfos:n,content:i}=e;return n&&t.push(...n),i&&Array.isArray(i)?(i.forEach((e=>{if("fields"===e.type){const n=null===e||void 0===e?void 0:e.fieldInfos;n&&t.push(...n)}})),t):t}function $(e){return e.replaceAll(I,(e=>"&#".concat(e.charCodeAt(0),";")))}function K(e){return"string"==typeof e?e.replaceAll(b,'<br class="esri-text-new-line" />'):e}function W(e){var t;const{value:n,fieldName:i,fieldInfos:r,fieldInfoMap:a,layer:l,graphic:s,timeZone:c}=e;if(null==n)return"";const y=function(e){let{fieldName:t,value:n,graphic:i,layer:r}=e;if(ne(t))return null;if(!r||"function"!=typeof r.getFieldDomain)return null;const a=i&&r.getFieldDomain(t,{feature:i,excludeImpliedDomains:(0,o.A)("esri-widget-legacy-field-domain-calculation")});return a&&"coded-value"===a.type?a.getName(n):null}({fieldName:i,value:n,graphic:s,layer:l});if(y)return y;const p=function(e){let{fieldName:t,graphic:n,layer:i}=e;if(ne(t))return null;if(!i||"function"!=typeof i.getFeatureType)return null;const{typeIdField:o}=i;if(!o||t!==o)return null;const r=i.getFeatureType(n);return r?r.name:null}({fieldName:i,graphic:s,layer:l});if(p)return p;if(a.get(i.toLowerCase()))return V(n,{fieldInfos:r||Array.from(a.values()),fieldName:i,layer:l,timeZone:c});const f=null===l||void 0===l||null===(t=l.fieldsIndex)||void 0===t?void 0:t.get(i);return f&&((0,d.fs)(f)||(0,u.isTimeOnlyField)(f))?(0,d.i0)(n,{fieldType:f.type,timeZoneOptions:{layerTimeZone:l&&"preferredTimeZone"in l?l.preferredTimeZone:null,viewTimeZone:c,datesInUnknownTimezone:!(!l||!("datesInUnknownTimezone"in l))&&!!l.datesInUnknownTimezone}}):K(n)}function X(e){let{fieldInfos:t,attributes:n,layer:i,graphic:o,fieldInfoMap:r,relatedInfos:a,timeZone:l}=e;const s={};return null!==a&&void 0!==a&&a.forEach((e=>function(e){var t,n;let{attributes:i,relatedInfo:o,fieldInfoMap:r,fieldInfos:a,layer:l,timeZone:s}=e;i&&o&&(null!==(t=o.relatedFeatures)&&void 0!==t&&t.forEach((e=>ie({attributes:i,graphic:e,relatedInfo:o,fieldInfoMap:r,fieldInfos:a,layer:l,timeZone:s}))),null===(n=o.relatedStatsFeatures)||void 0===n||n.forEach((e=>ie({attributes:i,graphic:e,relatedInfo:o,fieldInfoMap:r,fieldInfos:a,layer:l,timeZone:s}))))}({attributes:s,relatedInfo:e,fieldInfoMap:r,fieldInfos:t,layer:i,timeZone:l}))),n&&Object.keys(n).forEach((e=>{const a=n[e];s[e]=W({fieldName:e,fieldInfos:t,fieldInfoMap:r,layer:i,value:a,graphic:o,timeZone:l})})),s}async function ee(e,t){var n;const{layer:i,graphic:o,outFields:r,objectIds:a,returnGeometry:l,spatialReference:s}=e,u=a[0];if("number"!=typeof u&&"string"!=typeof u){const e="Could not query required fields for the specified feature. The feature's ID is invalid.",t={layer:i,graphic:o,objectId:u,requiredFields:r};return f().warn(e,t),null}if(null===(n=(0,c.BR)(i))||void 0===n||null===(n=n.operations)||void 0===n||!n.supportsQuery){const e="The specified layer cannot be queried. The following fields will not be available.",t={layer:i,graphic:o,requiredFields:r,returnGeometry:l};return f().warn(e,t),null}const d=i.createQuery();return d.objectIds=a,d.outFields=null!==r&&void 0!==r&&r.length?r:[i.objectIdField],d.returnGeometry=!!l,d.returnZ=!!l,d.returnM=!!l,d.outSpatialReference=s,(await i.queryFeatures(d,t)).features[0]}async function te(e,t){let{graphic:n,popupTemplate:o,layer:r,spatialReference:a}=e;if(!r||!o)return;if("function"==typeof r.load&&await r.load(t),!n.attributes)return;const l=r.objectIdField,s=n.attributes[l];if(null==s)return;const c=[s],d=await o.getRequiredFields(r.fieldsIndex),p=(0,u.featureHasFields)(d,n),f=p?[]:d.includes(l)?d:[...d,l],h=o.returnGeometry||await async function(e){var t;if(null===(t=e.expressionInfos)||void 0===t||!t.length)return!1;const n=await(0,y.lw)(),{arcadeUtils:{hasGeometryFunctions:i}}=n;return i(e)}(o);if(p&&!h)return;const v=await ee({layer:r,graphic:n,outFields:f,objectIds:c,returnGeometry:h,spatialReference:a},t);v&&(v.geometry&&(n.geometry=v.geometry),v.attributes&&(n.attributes=(0,i.A)((0,i.A)({},n.attributes),v.attributes)))}function ne(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";return!!e&&e.includes(A)}function ie(e){let{attributes:t,graphic:n,relatedInfo:i,fieldInfos:o,fieldInfoMap:r,layer:a,timeZone:l}=e;t&&n&&i&&Object.keys(n.attributes).forEach((e=>{const s=function(e){return"".concat(A).concat(e.layerId,"/").concat(e.fieldName)}({layerId:i.relation.id.toString(),fieldName:e}),u=n.attributes[e];t[s]=W({fieldName:s,fieldInfos:o,fieldInfoMap:r,layer:a,value:u,graphic:n,timeZone:l})}))}const oe=e=>{if(!e)return!1;const t=e.toUpperCase();return t.includes("CURRENT_TIMESTAMP")||t.includes("CURRENT_DATE")||t.includes("CURRENT_TIME")},re=e=>{var t;let{layer:n,method:i,query:o,definitionExpression:r}=e;if(null===(t=n.capabilities)||void 0===t||null===(t=t.query)||void 0===t||!t.supportsCacheHint||"attachments"===i)return;const a=null!=o.where?o.where:null,l=null!=o.geometry?o.geometry:null;oe(r)||oe(a)||"extent"===(null===l||void 0===l?void 0:l.type)||"tile"===o.resultType||(o.cacheHint=!0)},ae=e=>{var t;let{query:n,layer:i,method:o}=e;re({layer:i,method:o,query:n,definitionExpression:"".concat(i.definitionExpression," ").concat(null!==(t=i.serviceDefinitionExpression)&&void 0!==t?t:"")})},le=e=>{var t;let{queryPayload:n,layer:i,method:o}=e;re({layer:i,method:o,query:n,definitionExpression:"".concat(i.definitionExpression," ").concat(null!==(t=i.serviceDefinitionExpression)&&void 0!==t?t:"")})};function se(e,t,n){var i,o;return e&&t&&n?"sublayer"===t.type?de({layers:null===(i=t.layer)||void 0===i?void 0:i.sublayers,map:e,relatedLayer:t,relationship:n})||de({layers:null===(o=t.layer)||void 0===o?void 0:o.subtables,map:e,relatedLayer:t,relationship:n}):de({layers:e.allLayers,map:e,relatedLayer:t,relationship:n})||de({layers:e.allTables,map:e,relatedLayer:t,relationship:n}):null}function ue(e,t){var n;return e&&"utilityNetworks"in e&&t?null===(n=e.utilityNetworks)||void 0===n?void 0:n.find((e=>e.isUtilityLayer(t))):null}function ce(e,t){return null===e||void 0===e?void 0:e.allTables.find((e=>{var n;return"feature"===e.type&&e.layerId===t.id&&e.url===(null===(n=t.layer)||void 0===n?void 0:n.url)}))}function de(e){let{map:t,relationship:n,relationship:{relatedTableId:i},relatedLayer:o,layers:r}=e;if(!r)return null;for(const l of r){var a;if("map-image"===l.type){const e=de({layers:l.sublayers,map:t,relatedLayer:o,relationship:n})||de({layers:l.subtables,map:t,relatedLayer:o,relationship:n});if(e)return e;continue}if(!P(l))continue;if("sublayer"===o.type){if(l!==o&&l.id===i)return l.isTable?ce(t,l):l;continue}const e="scene"===o.type&&o.associatedLayer?o.associatedLayer.url:o.url;if(!e)return null;if("sublayer"!==l.type){if(l!==o&&l.url===e&&l.layerId===i)return l}else if(l!==o&&(null===(a=l.layer)||void 0===a?void 0:a.url)===e&&l.id===i)return l.isTable?ce(t,l):l}return null}function ye(e){const t=e.getObjectId();return null!=t?"oid:".concat(t):"uid:".concat(e.uid)}},91039:(e,t,n)=>{n.d(t,{A:()=>w});var i=n(35143),o=n(39356),r=n(91967),a=n(69098),l=n(19276),s=n(5632),u=n(50346),c=n(67993),d=n(68134),y=n(46053),p=(n(81806),n(76460),n(47249),n(85842)),f=n(31933),h=n(64533),v=n(68295);const m="assetgroup",g="assettype";var b=n(9912);let I=class extends(a.A.ClonableMixin(s.A.IdentifiableMixin(r.default))){constructor(e){super(e),this._loaded=!1,this._queryAbortController=null,this._queryPageAbortController=null,this._queryFeatureCountAbortController=null,this.networkSourceIdsInUse=new Set,this.source="popup",this.description=null,this.graphic=null,this.layer=null,this.map=null,this.featureCount=0,this.associationTypes=null,this.showAllEnabled=!1,this.title=null,this.attachmentsFeatureCount=0,this.structureFeatureCount=0,this.contentFeatureCount=0,this.containerFeatureCount=0,this.connectivityFeatureCount=0,this._queryOpenAssociationType=async()=>{this.activeAssociationType&&await this._queryDebounced(this.activeAssociationType)},this._cancelQuery=()=>{const{_queryAbortController:e}=this;e&&e.abort(),this._queryAbortController=null},this._cancelQueryFeatureCount=()=>{const{_queryFeatureCountAbortController:e}=this;e&&e.abort(),this._queryFeatureCountAbortController=null},this._queryController=async e=>{this._cancelQuery();const t=new AbortController;this._queryAbortController=t,await(0,u.ignoreAbortErrors)(this._query(e)),this._queryAbortController===t&&(this._queryAbortController=null)},this._queryFeatureCountController=async()=>{this._loaded=!1,this._cancelQueryFeatureCount();const e=new AbortController;this._queryFeatureCountAbortController=e,await(0,u.ignoreAbortErrors)(this._queryFeatureCount()),this._queryFeatureCountAbortController===e&&(this._queryFeatureCountAbortController=null),this._loaded=!0},this._queryDebounced=(0,u.debounce)(this._queryController,100),this._queryFeatureCountDebounced=(0,u.debounce)(this._queryFeatureCountController,100)}initialize(){this.addHandles([(0,d.watch)((()=>[this.graphic,this.layer,this.map,this.associationTypes,this.objectId,this.globalId,this.canQuery]),(()=>this.refresh()),d.initial),(0,d.watch)((()=>this.activeAssociationType),(e=>this._queryDebounced(e)),d.initial)])}destroy(){this._cancelQuery(),this._cancelQueryFeatureCount(),this._destroyAssociatedFeatureViewModels()}get supportsCacheHint(){var e;return!(null===(e=this.layer)||void 0===e||null===(e=e.capabilities)||void 0===e||null===(e=e.query)||void 0===e||!e.supportsCacheHint)}get canLoad(){return!!this.map&&!!this.associationTypes&&"string"==typeof this.globalId}get canQuery(){var e;const t=null===(e=this.layer)||void 0===e||null===(e=e.capabilities)||void 0===e?void 0:e.query;return!!this.associationTypes&&"string"==typeof this.globalId&&!(null===t||void 0===t||!t.supportsPagination)}set displayCount(e){this._set("displayCount",Math.max(null!==e&&void 0!==e?e:3,0))}get displayCount(){return this._get("displayCount")}get objectId(){var e,t;return null!==(e=this.objectIdField&&(null===(t=this.graphic)||void 0===t||null===(t=t.attributes)||void 0===t?void 0:t[this.objectIdField]))&&void 0!==e?e:null}get objectIdField(){var e;return(null===(e=this.layer)||void 0===e?void 0:e.objectIdField)||null}get globalId(){var e,t;return null!==(e=this.globalIdField&&(null===(t=this.graphic)||void 0===t||null===(t=t.attributes)||void 0===t?void 0:t[this.globalIdField]))&&void 0!==e?e:null}get globalIdField(){const{layer:e}=this;return null===e||void 0===e?void 0:e.globalIdField}get activeAssociationType(){return this._get("activeAssociationType")}set activeAssociationType(e){e&&!this.associationTypes.includes(e)||this._set("activeAssociationType",e)}get state(){const{_queryAbortController:e,_queryFeatureCountAbortController:t,_queryPageAbortController:n,canQuery:i,_loaded:o,canLoad:r,source:a}=this;return t||r&&!o?"loading":e||n?"querying":!i||"popup"===a&&0===this.featureCount?"disabled":"ready"}get utilityNetwork(){const{layer:e,map:t}=this;if(null===e||void 0===e||!e.loaded||!t)return null;const n=(0,f.Sv)(e)?e.parent:e;return(0,b.findUtilityNetwork)(t,n)}get attachmentsAssociations(){return this._get("attachmentsAssociations")||new l.default}get structureAssociations(){return this._get("structureAssociations")||new l.default}get contentAssociations(){return this._get("contentAssociations")||new l.default}get containerAssociations(){return this._get("containerAssociations")||new l.default}get connectivityAssociations(){return this._get("connectivityAssociations")||new l.default}get associationFeatures(){return this._get("associationFeatures")||new c.A}get associationViewModels(){return this._get("associationViewModels")||new Map}async refresh(){await this._queryFeatureCountDebounced(),await this._queryOpenAssociationType()}getFeatureCountForAssociationType(e){switch(e){case"attachment":return this.attachmentsFeatureCount;case"structure":return this.structureFeatureCount;case"content":return this.contentFeatureCount;case"container":return this.containerFeatureCount;case"connectivity":return this.connectivityFeatureCount}}_destroyAssociatedFeatureViewModels(){this.associationViewModels.forEach((e=>e.destroyAll()))}async _loadUtiltyNetworks(){var e,t;const n=this.map;if(!n)return;await Promise.allSettled(null!==(e=null===(t=n.utilityNetworks)||void 0===t?void 0:t.map((async e=>{await e.load()})))&&void 0!==e?e:[]);const i=this.utilityNetwork;if(i){const e=e=>{if("layerId"in e&&i.isUtilityLayer(e)){const t=i.getSourceIdByLayerId(e.layerId);null!==t&&this.networkSourceIdsInUse.add(t)}};this._set("networkSourceIdsInUse",new Set),n.allLayers.forEach(e),n.allTables.forEach(e)}}async _findLayersBySourceId(e){const{utilityNetwork:t,map:n}=this,i=e=>{const n=e;return!!e.url&&(n.layerId===o&&e.url.replace(/\/\d+$/,"")===(null===t||void 0===t?void 0:t.featureServiceUrl))};await(null===t||void 0===t?void 0:t.load());const o=t.getLayerIdBySourceId(e),r=n.allLayers.filter(i),a=n.allTables.filter(i),l=r.concat(a).toArray();return await Promise.allSettled(l.map((e=>e.load()))),l}_clearAssociations(){this.attachmentsAssociations.removeAll(),this.structureAssociations.removeAll(),this.contentAssociations.removeAll(),this.containerAssociations.removeAll(),this.connectivityAssociations.removeAll()}_clearFeatures(){this.associationFeatures.forEach((e=>e.removeAll())),this.associationFeatures.clear()}_getAssociationsByType(e){switch(e){case"attachment":return this.attachmentsAssociations;case"structure":return this.structureAssociations;case"connectivity":return this.connectivityAssociations;case"container":return this.containerAssociations;case"content":return this.contentAssociations}}async _queryLayer(e,t,n,i,o){const r=e.fieldsIndex.get(m),a=e.fieldsIndex.get(g),l=null!=n,s=null!=i,u="("+t.map((e=>"'".concat(e,"'"))).join(", ")+")",c=l?" AND ".concat(null===r||void 0===r?void 0:r.name," = ").concat(n):"",d=l&&s?" AND ".concat(null===a||void 0===a?void 0:a.name," = ").concat(i):"",y="".concat(e.globalIdField," IN ").concat(u)+c+d,p=new v.default({outFields:["*"],cacheHint:this.supportsCacheHint,where:y});return await this._queryAll(p,e,{signal:null===o||void 0===o?void 0:o.signal})}async _createAssociationFeatureObjects(e,t,n,i,o,r){if(0===e.length)return[];const a=new Map;for(const[s,u]of t){const e=await this._findLayersBySourceId(s);for(const t of e)(await this._queryLayer(t,u,i,o,r)).forEach((e=>{if("popup"===this.source?e.layer&&e.getEffectivePopupTemplate():e.layer){var n;const i=null!==(n=a.get(e.attributes[t.globalIdField]))&&void 0!==n?n:[];i.push(e),a.set(e.attributes[t.globalIdField],i)}}))}const l=[];return await Promise.all(e.toArray().map((async e=>{var t;const{fromNetworkElement:i,toNetworkElement:o}=e,r=i.globalId===n?o:i,s=null!==(t=a.get(r.globalId))&&void 0!==t?t:[];await Promise.all(s.map((async t=>{var n;const i=null===(n=this.utilityNetwork)||void 0===n||null===(n=n.getTerminalById(null===r||void 0===r?void 0:r.terminalId))||void 0===n?void 0:n.name;if(t.layer&&"getFeatureTitle"in t.layer){const n=await t.layer.getFeatureTitle(t);l.push({title:n,association:e,feature:t,terminalName:i})}else l.push({association:e,feature:t,terminalName:i})})))}))),l}_parseFeatureObjects(e,t){e.forEach((e=>{var n;const i=(null===e||void 0===e?void 0:e.feature).layer,o=null!==(n=t.get(i))&&void 0!==n?n:new l.default;o.add(e),t.set(i,o)}))}async _queryAll(e,t,n){var i,o;const r=[];let a=0,l=!1;e.num=null!==(i=null===(o=t.sourceJSON)||void 0===o?void 0:o.maxRecordCount)&&void 0!==i?i:2e3;do{e.start=a;const i=await t.queryFeatures(e,n);r.push(...i.features),l=i.exceededTransferLimit,l&&(a+=i.features.length)}while(l);return r}async _queryAssociations(e){const{layer:t,globalId:n,associationTypes:i,utilityNetwork:o,canQuery:r}=this;if(await Promise.allSettled([null===t||void 0===t?void 0:t.load(),null===o||void 0===o?void 0:o.load()]),this._clearAssociations(),!(r&&t&&i&&o&&n))return;const a=(0,f.Sv)(t)?t.parent:t,l=new h.default({globalId:n,networkSourceId:o.getSourceIdByLayerId(a.layerId)}),s=new Set;i.forEach((e=>{switch(e.type){case"attachment":case"structure":s.add("attachment");break;case"container":case"content":s.add("containment");break;case"connectivity":s.add("connectivity"),s.add("junction-junction-connectivity"),s.add("junction-edge-from-connectivity"),s.add("junction-edge-midspan-connectivity"),s.add("junction-edge-to-connectivity")}}));const u=await(null===o||void 0===o?void 0:o.queryAssociations({elements:[l],types:Array.from(s)},{signal:null===e||void 0===e?void 0:e.signal})),c=new Map,d=new Map;i.forEach((e=>{d.set(e.type,e),c.set(e.type,[])})),u.forEach((e=>{const{toNetworkElement:t,fromNetworkElement:i}=e;switch(e.associationType){case"connectivity":case"junction-junction-connectivity":case"junction-edge-from-connectivity":case"junction-edge-midspan-connectivity":case"junction-edge-to-connectivity":if((null===i||void 0===i?void 0:i.globalId)===n){var o;if(this._shouldDiscardNetworkElement(t,"connectivity",d))break;null===(o=c.get("connectivity"))||void 0===o||o.push(t.globalId)}else{var r;if(this._shouldDiscardNetworkElement(i,"connectivity",d))break;null===(r=c.get("connectivity"))||void 0===r||r.push(i.globalId)}this.connectivityAssociations.add(e);break;case"containment":if((null===i||void 0===i?void 0:i.globalId)===n){var a;if(this._shouldDiscardNetworkElement(t,"content",d))break;null!==(a=c.get("content"))&&void 0!==a&&a.push(t.globalId),this.contentAssociations.add(e)}else{var l;if(this._shouldDiscardNetworkElement(i,"container",d))break;null!==(l=c.get("container"))&&void 0!==l&&l.push(i.globalId),this.containerAssociations.add(e)}break;case"attachment":if((null===i||void 0===i?void 0:i.globalId)===n){var s;if(this._shouldDiscardNetworkElement(t,"attachment",d))break;null!==(s=c.get("attachment"))&&void 0!==s&&s.push(t.globalId),this.attachmentsAssociations.add(e)}else{var u;if(this._shouldDiscardNetworkElement(i,"structure",d))break;null!==(u=c.get("structure"))&&void 0!==u&&u.push(i.globalId),this.structureAssociations.add(e)}}}));const y=i.map((async t=>{const{associatedNetworkSourceId:n,associatedAssetGroup:i,associatedAssetType:o}=t,r=c.get(t.type),a=null!=i?await this._countAssociatedFeatures(n,r,i,o,e):r.length;switch(t.type){case"attachment":this._set("attachmentsFeatureCount",a);break;case"structure":this._set("structureFeatureCount",a);break;case"content":this._set("contentFeatureCount",a);break;case"container":this._set("containerFeatureCount",a);break;case"connectivity":this._set("connectivityFeatureCount",a)}}));await Promise.allSettled(y)}async _countAssociatedFeatureCount(e,t,n,i,o){const r=e.fieldsIndex.get(m),a=e.fieldsIndex.get(g),l=null!=i,s="("+t.map((e=>"'".concat(e,"'"))).join(", ")+")",u=" AND ".concat(null===r||void 0===r?void 0:r.name," = ").concat(n),c=l?" AND ".concat(null===a||void 0===a?void 0:a.name," = ").concat(i):"",d="".concat(e.globalIdField," IN ").concat(s)+u+c;return e.queryFeatureCount({where:d,outFields:["*"],returnGeometry:!1},{signal:null===o||void 0===o?void 0:o.signal})}async _countAssociatedFeatures(e,t,n,i,o){if(0===t.length)return 0;const r=(await this._findLayersBySourceId(e)).map((async e=>this._countAssociatedFeatureCount(e,t,n,i,o)));return(await Promise.all(r)).reduce(((e,t)=>e+t),0)}async _queryAssociatedFeatures(e,t){const{layer:n,globalId:i,associationTypes:o,utilityNetwork:r,canQuery:a,associationFeatures:l}=this;if(await Promise.allSettled([null===n||void 0===n?void 0:n.load(),null===r||void 0===r?void 0:r.load()]),!(a&&n&&o&&r))return;const s=this._getAssociationsByType(e.type),{associatedAssetGroup:u,associatedAssetType:c}=e,d=new Map;s.forEach((e=>{const{fromNetworkElement:t,toNetworkElement:n}=e,{networkSourceId:o,elementGlobalId:r}=t.globalId===i?{networkSourceId:n.networkSourceId,elementGlobalId:n.globalId}:{networkSourceId:t.networkSourceId,elementGlobalId:t.globalId},a=d.get(o)||[];a.push(r),d.set(o,a)}));const y=await this._createAssociationFeatureObjects(s,d,i,u,c,t);this._parseFeatureObjects(y,l)}async _queryFeatureCount(){await this._loadUtiltyNetworks();const{_queryFeatureCountAbortController:e,canQuery:t}=this;t?(await this._queryAssociations(e),this._set("featureCount",this.attachmentsFeatureCount+this.structureFeatureCount+this.contentFeatureCount+this.containerFeatureCount+this.connectivityFeatureCount)):this._set("featureCount",0)}async _query(e){if(!e)return;await this._loadUtiltyNetworks();const{_queryAbortController:t}=this;this._destroyAssociatedFeatureViewModels(),this._clearFeatures(),0!==this.featureCount&&(this.destroyed||await this._queryAssociatedFeatures(e,{signal:null===t||void 0===t?void 0:t.signal}))}_shouldDiscardNetworkElement(e,t,n){var i;if(!e)return!1;const{networkSourceIdsInUse:o}=this,{networkSourceId:r}=e,a=null===(i=n.get(t))||void 0===i?void 0:i.associatedNetworkSourceId,l=o.has(r);return null!=a&&a!==r||!l}};(0,i._)([(0,y.MZ)()],I.prototype,"_loaded",void 0),(0,i._)([(0,y.MZ)()],I.prototype,"_queryAbortController",void 0),(0,i._)([(0,y.MZ)()],I.prototype,"_queryPageAbortController",void 0),(0,i._)([(0,y.MZ)()],I.prototype,"_queryFeatureCountAbortController",void 0),(0,i._)([(0,y.MZ)({readOnly:!0})],I.prototype,"supportsCacheHint",null),(0,i._)([(0,y.MZ)({readOnly:!0})],I.prototype,"canLoad",null),(0,i._)([(0,y.MZ)({readOnly:!0})],I.prototype,"canQuery",null),(0,i._)([(0,y.MZ)()],I.prototype,"networkSourceIdsInUse",void 0),(0,i._)([(0,y.MZ)({constructOnly:!0})],I.prototype,"source",void 0),(0,i._)([(0,y.MZ)()],I.prototype,"description",void 0),(0,i._)([(0,y.MZ)({value:3})],I.prototype,"displayCount",null),(0,i._)([(0,y.MZ)({type:o.default})],I.prototype,"graphic",void 0),(0,i._)([(0,y.MZ)()],I.prototype,"layer",void 0),(0,i._)([(0,y.MZ)()],I.prototype,"map",void 0),(0,i._)([(0,y.MZ)({readOnly:!0})],I.prototype,"objectId",null),(0,i._)([(0,y.MZ)({readOnly:!0})],I.prototype,"objectIdField",null),(0,i._)([(0,y.MZ)({readOnly:!0})],I.prototype,"globalId",null),(0,i._)([(0,y.MZ)({readOnly:!0})],I.prototype,"globalIdField",null),(0,i._)([(0,y.MZ)()],I.prototype,"featureCount",void 0),(0,i._)([(0,y.MZ)()],I.prototype,"associationTypes",void 0),(0,i._)([(0,y.MZ)()],I.prototype,"activeAssociationType",null),(0,i._)([(0,y.MZ)()],I.prototype,"showAllEnabled",void 0),(0,i._)([(0,y.MZ)()],I.prototype,"state",null),(0,i._)([(0,y.MZ)()],I.prototype,"title",void 0),(0,i._)([(0,y.MZ)({readOnly:!0})],I.prototype,"utilityNetwork",null),(0,i._)([(0,y.MZ)({readOnly:!0})],I.prototype,"attachmentsFeatureCount",void 0),(0,i._)([(0,y.MZ)({readOnly:!0})],I.prototype,"structureFeatureCount",void 0),(0,i._)([(0,y.MZ)({readOnly:!0})],I.prototype,"attachmentsAssociations",null),(0,i._)([(0,y.MZ)({readOnly:!0})],I.prototype,"structureAssociations",null),(0,i._)([(0,y.MZ)({readOnly:!0})],I.prototype,"contentFeatureCount",void 0),(0,i._)([(0,y.MZ)({readOnly:!0})],I.prototype,"containerFeatureCount",void 0),(0,i._)([(0,y.MZ)({readOnly:!0})],I.prototype,"contentAssociations",null),(0,i._)([(0,y.MZ)({readOnly:!0})],I.prototype,"containerAssociations",null),(0,i._)([(0,y.MZ)({readOnly:!0})],I.prototype,"connectivityFeatureCount",void 0),(0,i._)([(0,y.MZ)({readOnly:!0})],I.prototype,"connectivityAssociations",null),(0,i._)([(0,y.MZ)({readOnly:!0})],I.prototype,"associationFeatures",null),(0,i._)([(0,y.MZ)({readOnly:!0})],I.prototype,"associationViewModels",null),I=(0,i._)([(0,p.$)("esri.widgets.support.UtilityNetworkAssociations.FeatureUtilityNetworkAssociationsViewModel")],I);const w=I}}]);
//# sourceMappingURL=91039.fb1d64cd.chunk.js.map