"use strict";(self.webpackChunksc_depot=self.webpackChunksc_depot||[]).push([[78787],{78787:(e,i,l)=>{l.r(i),l.d(i,{default:()=>F});var t=l(35143),s=l(91967),o=l(98773),r=l(19276),n=l(50076),d=l(50346),a=l(68134),v=l(91417),u=l(46053),h=(l(81806),l(76460),l(47249),l(85842)),c=l(15372),f=l(93619),y=l(42052),p=l(79535);let m=class extends((0,p.A)(s.default)){constructor(e){super(e),this.filterMenuOpen=!1,this.filterMenuType="site",this.filterMode="base-floors",this.levelsExpanded=!0,this.searchTerm=null,this.view=null,this._updateFloorFilterTask=null,this._viewHeightBreakpoint=null,this._viewWidthBreakpoint=null}initialize(){this.addHandles([(0,a.watch)((()=>{var e;return null===(e=this.view)||void 0===e?void 0:e.map}),(e=>{null!=this._updateFloorFilterTask&&(this._updateFloorFilterTask.abort(),this._updateFloorFilterTask=null),this._updateFloorFilterTask=(0,o.UT)((async i=>{await this._updateFloorFilterFromMap(e),(0,d.throwIfAborted)(i),this._setInitialViewState(e)}))}),a.initial),(0,a.watch)((()=>this.view),((e,i)=>{this._unregisterWidget(i),this._registerWidget(e),this._watchSearchResults(e)}),a.syncAndInitial),(0,a.watch)((()=>{var e,i;return null!==(e=null===(i=this.view)||void 0===i?void 0:i.widthBreakpoint)&&void 0!==e?e:null}),(e=>{this._viewWidthBreakpoint=e})),(0,a.watch)((()=>{var e,i;return null!==(e=null===(i=this.view)||void 0===i?void 0:i.heightBreakpoint)&&void 0!==e?e:null}),(e=>{this._viewHeightBreakpoint=e}))])}destroy(){this._unregisterWidget(this.view),this.view=null,null!=this._updateFloorFilterTask&&(this._updateFloorFilterTask.abort(),this._updateFloorFilterTask=null)}set enabled(e){this._callOverride("enabled",e)}set facility(e){if(e&&this._isOverridden("facility")){const i=this.getFacility(e);this.hasMultipleSites&&(this.site=(null===i||void 0===i?void 0:i.siteId)||null)}this._callOverride("facility",e)}set filterFeatures(e){this._callOverride("filterFeatures",e)}set filterLayers(e){this._callOverride("filterLayers",e)}get hasFacilities(){var e,i;return null!=(null===(e=this.filterLayers)||void 0===e?void 0:e.facilityLayer)&&(null===(i=this.filterFeatures)||void 0===i||null===(i=i.facilities)||void 0===i||null===(i=i.facilitiesInfo)||void 0===i?void 0:i.length)>0}get hasLevels(){var e,i;return null!=(null===(e=this.filterLayers)||void 0===e?void 0:e.levelLayer)&&(null===(i=this.filterFeatures)||void 0===i||null===(i=i.levels)||void 0===i||null===(i=i.levelsInfo)||void 0===i?void 0:i.length)>0}get hasMultipleSites(){var e,i;return null!=(null===(e=this.filterLayers)||void 0===e?void 0:e.siteLayer)&&(null===(i=this.filterFeatures)||void 0===i||null===(i=i.sites)||void 0===i||null===(i=i.sitesInfo)||void 0===i?void 0:i.length)>1}get isNormalMode(){let e=!0;const i=this._viewWidthBreakpoint;return"xsmall"!==this._viewHeightBreakpoint&&"xsmall"!==i||(e=!1),e}set level(e){var i,l,t;if(!e)return this._callOverride("level",e),this.facility=null,this.site=null,void this.setFloors(null);let s=null,o=null;const r=null===e||void 0===e?void 0:e.split("--");if((null===r||void 0===r?void 0:r.length)>1&&"all"===r[0]?(o=r[1],s={id:e,facilityId:o,shortName:null,longName:null,levelNumber:null,verticalOrder:null}):(s=this.getLevel(e),o=null!==(i=null===(l=s)||void 0===l?void 0:l.facilityId)&&void 0!==i?i:null),this.level!==e||this.isNormalMode||this.levelsExpanded)s&&this.hasFacilities&&this.hasLevels?(this.facility=o,this.hasMultipleSites&&(this.site=(null===(t=this.getFacility(o))||void 0===t?void 0:t.siteId)||null),this.setFloors(s)):this._isOverridden("level")&&(this.facility=null,this.site=null,this.hasMultipleSites&&(this.filterMenuType="site"),this.setFloors(null)),this._callOverride("level",e);else{const e=this.getFacilityLevels(o);(null===e||void 0===e?void 0:e.length)>1&&(this.levelsExpanded=!0)}}set longNames(e){this._callOverride("longNames",e)}set minimized(e){this._callOverride("minimized",e)}set pinnedLevels(e){this._callOverride("pinnedLevels",e)}set site(e){this._callOverride("site",e)}get state(){return this.view&&this.filterFeatures&&this.hasFacilities&&this.hasLevels?"ready":this.view&&!this.filterFeatures?"loading":"disabled"}filterFacilities(e){let i=e;return this.searchTerm&&(this.searchTerm=this.searchTerm.trim(),i=e.filter((e=>{var i;const{name:l}=e;return l.toLowerCase().includes(null===(i=this.searchTerm)||void 0===i?void 0:i.toLowerCase())}))),this.site&&(i=i.filter((e=>e.siteId===this.site))),i.sort(((e,i)=>{const l=e.name,t=i.name;return l.localeCompare(t,void 0,{sensitivity:"base"})}))}filterSites(e){let i=e;return this.searchTerm&&(this.searchTerm=this.searchTerm.trim(),i=e.filter((e=>{var i;const{name:l}=e;return l.toLowerCase().includes(null===(i=this.searchTerm)||void 0===i?void 0:i.toLowerCase())}))),i.sort(((e,i)=>{const l=e.name,t=i.name;return l.localeCompare(t,void 0,{sensitivity:"base"})}))}getBaseLevel(e){var i;const l=null===(i=this.filterFeatures)||void 0===i||null===(i=i.levels)||void 0===i?void 0:i.levelsInfo;let t=null;if(e){const{id:i}=e;if(l&&l.length>0&&(l.forEach((e=>{0===e.verticalOrder&&e.facilityId===i&&(t=e)})),!t)){let e=null;l.forEach((l=>{var t,s;l.facilityId===i&&(e?(null!==(t=l.verticalOrder)&&void 0!==t?t:0)>=0?null!=e.verticalOrder&&(e.verticalOrder<0||(null!==(s=l.verticalOrder)&&void 0!==s?s:0)<e.verticalOrder)&&(e=l):null!=e.verticalOrder&&null!=l.verticalOrder&&e.verticalOrder<0&&l.verticalOrder>e.verticalOrder&&(e=l):e=l)})),e&&(t=e)}}return t}getFacility(e){var i,l;return null!==(i=null===(l=this.filterFeatures)||void 0===l||null===(l=l.facilities)||void 0===l||null===(l=l.facilitiesInfo)||void 0===l?void 0:l.find((i=>i.id===e)))&&void 0!==i?i:null}getFacilityLevels(e){var i;return e&&null!==(i=this.filterFeatures)&&void 0!==i&&null!==(i=i.levels)&&void 0!==i&&i.levelsInfo?this.filterFeatures.levels.levelsInfo.filter((i=>i.facilityId===e)).sort(((e,i)=>{var l,t;const s=null!==(l=e.verticalOrder)&&void 0!==l?l:0,o=null!==(t=i.verticalOrder)&&void 0!==t?t:0;return s>o?-1:s===o?0:1})):[]}getLevel(e){var i,l;return null!==(i=null===(l=this.filterFeatures)||void 0===l||null===(l=l.levels)||void 0===l||null===(l=l.levelsInfo)||void 0===l?void 0:l.find((i=>i.id===e)))&&void 0!==i?i:null}getSite(e){var i,l;return null!==(i=null===(l=this.filterFeatures)||void 0===l||null===(l=l.sites)||void 0===l||null===(l=l.sitesInfo)||void 0===l?void 0:l.find((i=>i.id===e)))&&void 0!==i?i:null}goTo(e){const{view:i}=this;if(!i||!e)return;const{geometry:l}=e;l&&l.extent&&this.callGoTo({target:l.extent,options:{duration:(0,v.l5)(1e3),easing:"in-out-quad"}})}setFloors(e){var i;const{view:l}=this;l&&(null!==l&&void 0!==l&&null!==(i=l.map)&&void 0!==i&&null!==(i=i.allLayers)&&void 0!==i&&i.forEach((e=>{"feature"===e.type&&this._computeViewAllModeFloors(e)})),l.floors=new r.default(this._computeFloors(e)))}updateWebDocument(e){if((0,y.r)(e)){var i,l,t;const s=new f.A({enabled:this.enabled,longNames:this.longNames,minimized:this.minimized,pinnedLevels:this.pinnedLevels,site:null!==(i=this.site)&&void 0!==i?i:null,facility:null!==(l=this.facility)&&void 0!==l?l:null,level:null!==(t=this.level)&&void 0!==t?t:null});e.widgets?e.widgets.floorFilter=s:e.widgets=new c.A({floorFilter:s})}}_computeFloors(e){var i;if("single-floor"===this.filterMode)this._computeSingleFloor(e);else if("base-floors"===this.filterMode)return"3d"===(null===(i=this.view)||void 0===i?void 0:i.type)?this._computeBaseFloors3D(e):this._computeBaseFloors(e);return this._computeEmptyFloors()}_computeSingleFloor(e){if(!e)return this._computeEmptyFloors();const i=[];return"all"===(null===e||void 0===e?void 0:e.id)?this.getFacilityLevels(e.facilityId).forEach((e=>{e.id&&i.push(e.id)})):e&&i.push(e.id),i}_computeBaseFloors(e){var i;const l=null===(i=this.filterFeatures)||void 0===i||null===(i=i.levels)||void 0===i?void 0:i.levelsInfo;if(null===l||void 0===l||!l.length)return this._computeEmptyFloors();const t=[];"all"===(null===e||void 0===e?void 0:e.id)?this.getFacilityLevels(e.facilityId).forEach((e=>{e.id&&t.push(e.id)})):e&&t.push(e.id);const s=null===e||void 0===e?void 0:e.facilityId;return l.forEach((e=>{const{id:i,facilityId:l,verticalOrder:o}=e;(s||0!==o||t.includes(i))&&(l===s||0!==o||t.includes(i))||t.push(i)})),t}_computeBaseFloors3D(e){var i,l;const t=null===(i=this.filterFeatures)||void 0===i||null===(i=i.levels)||void 0===i?void 0:i.levelsInfo;if(null===t||void 0===t||!t.length)return this._computeEmptyFloors();const s=[],o=null!==(l=null===e||void 0===e?void 0:e.id.split("--"))&&void 0!==l?l:[];(null===o||void 0===o?void 0:o.length)>1&&"all"===o[0]?this.getFacilityLevels(null===e||void 0===e?void 0:e.facilityId).forEach((e=>{e.id&&s.push(e.id)})):e&&s.push(e.id);const r=null===e||void 0===e?void 0:e.facilityId;return t.forEach((e=>{const{id:i,facilityId:l}=e;(r||s.includes(i))&&(l===r||s.includes(i))||s.push(i)})),s}_computeEmptyFloors(){return[]}async _setFilterLayers(){const{view:e}=this;if(e&&!this._isOverridden("filterLayers")){if(!(0,y.r)(e.map)&&!function(e){return"esri.WebScene"===e.declaredClass}(e.map))throw new n.default("Map must be a webmap or webscene");{var i;const n=e.map,h=null===n||void 0===n?void 0:n.allLayers;if((null===h||void 0===h||null===(i=h.items)||void 0===i?void 0:i.length)>0){var l,t,s,o,r,d;const e={siteLayer:null,facilityLayer:null,levelLayer:null},i=null===(l=n.floorInfo)||void 0===l||null===(l=l.siteLayer)||void 0===l?void 0:l.layerId,c=null===(t=n.floorInfo)||void 0===t||null===(t=t.facilityLayer)||void 0===t?void 0:t.layerId,f=null===(s=n.floorInfo)||void 0===s||null===(s=s.levelLayer)||void 0===s?void 0:s.layerId,y=(null===(o=n.floorInfo)||void 0===o||null===(o=o.siteLayer)||void 0===o?void 0:o.sublayerId)||(null===(r=n.floorInfo)||void 0===r||null===(r=r.facilityLayer)||void 0===r?void 0:r.sublayerId)||(null===(d=n.floorInfo)||void 0===d||null===(d=d.levelLayer)||void 0===d?void 0:d.sublayerId);if(!c||!f)return;const p=h.items.filter((e=>"feature"===e.type||"scene"===e.type)),m=h.items.filter((e=>"map-image"===e.type));if((null===m||void 0===m?void 0:m.length)>0&&y){var a,v,u;await Promise.all(m.map((e=>e.load())));const l=null===(a=n.floorInfo)||void 0===a||null===(a=a.siteLayer)||void 0===a?void 0:a.sublayerId,t=null===(v=n.floorInfo)||void 0===v||null===(v=v.facilityLayer)||void 0===v?void 0:v.sublayerId,s=null===(u=n.floorInfo)||void 0===u||null===(u=u.levelLayer)||void 0===u?void 0:u.sublayerId;m.forEach((o=>{const r=o.id,n=null===o||void 0===o?void 0:o.allSublayers,d=null===n||void 0===n?void 0:n.items;(r===i||r===c||r===f)&&(null===d||void 0===d?void 0:d.length)>0&&n.items.forEach((o=>{const n=o.id;r===i&&n===l?e.siteLayer=o:n===t?e.facilityLayer=o:n===s&&(e.levelLayer=o)}))}))}(null===p||void 0===p?void 0:p.length)>0&&p.forEach((l=>{const t=l.id;t===i?e.siteLayer=l:t===c?e.facilityLayer=l:t===f&&(e.levelLayer=l)})),this.filterLayers=e}}}}async _getFilterFeatures(){if(this._isOverridden("filterFeatures"))return this.filterFeatures;const[e,i,l]=await Promise.all([this._getSites(),this._getFacilities(),this._getLevels()]);return{sites:e,facilities:i,levels:l}}async _getSites(){var e,i;const l={sitesInfo:[]},{filterLayers:t,view:s}=this,o=null===s||void 0===s?void 0:s.map,{siteLayer:r}=t;if(!r||null===o||void 0===o||null===(e=o.floorInfo)||void 0===e||!e.siteLayer)return l;const n=r.createQuery();n.returnGeometry=!0,n.outFields=["*"],n.returnZ=!0,"type"in r&&"scene"===r.type&&(n.multipatchOption="xyFootprint");const{siteIdField:d,nameField:a}=o.floorInfo.siteLayer,v=await r.queryFeatures(n);if((null===v||void 0===v||null===(i=v.features)||void 0===i?void 0:i.length)>0){var u,h;const e=v.features,i=(null===r||void 0===r||null===(u=r.fieldsIndex.get(d))||void 0===u?void 0:u.name)||d,t=(null===r||void 0===r||null===(h=r.fieldsIndex.get(a))||void 0===h?void 0:h.name)||a;null!=i&&null!=t&&e.forEach((e=>{const s=e.attributes,o=e.geometry,r=s[i],n=s[t];r&&n&&l.sitesInfo.push({id:r,name:n,geometry:o})}))}return l}async _getFacilities(){var e,i;const{filterLayers:l,view:t}=this,s=null===t||void 0===t?void 0:t.map,{facilityLayer:o}=l,r={facilitiesInfo:[]};if(!o||null===s||void 0===s||null===(e=s.floorInfo)||void 0===e||!e.facilityLayer)return r;const n=o.createQuery();n.returnGeometry=!0,n.outFields=["*"],n.returnZ=!0,"type"in o&&"scene"===o.type&&(n.multipatchOption="xyFootprint");const{facilityIdField:d,siteIdField:a,nameField:v}=s.floorInfo.facilityLayer,u=await o.queryFeatures(n);if((null===u||void 0===u||null===(i=u.features)||void 0===i?void 0:i.length)>0){var h,c,f;const e=u.features,i=(null===o||void 0===o||null===(h=o.fieldsIndex.get(d))||void 0===h?void 0:h.name)||d,l=(null===o||void 0===o||null===(c=o.fieldsIndex.get(a))||void 0===c?void 0:c.name)||a,t=(null===o||void 0===o||null===(f=o.fieldsIndex.get(v))||void 0===f?void 0:f.name)||v;i&&l&&t&&e.forEach((e=>{const s=e.attributes,o=e.geometry,n=s[i],d=s[l],a=s[t];n&&a&&r.facilitiesInfo.push({id:n,siteId:d,name:a,geometry:o})}))}return r}async _getLevels(){var e,i;const{filterLayers:l,view:t}=this,s=null===t||void 0===t?void 0:t.map,{levelLayer:o}=l,r={levelsInfo:[]};if(!o||null===s||void 0===s||null===(e=s.floorInfo)||void 0===e||!e.levelLayer)return r;const n=o.createQuery();n.returnGeometry=!0,n.outFields=["*"],n.returnZ=!0;const{levelIdField:d,facilityIdField:a,longNameField:v,shortNameField:u,levelNumberField:h,verticalOrderField:c}=s.floorInfo.levelLayer,f=await o.queryFeatures(n);if((null===f||void 0===f||null===(i=f.features)||void 0===i?void 0:i.length)>0){var y,p,m,F,g,_;const e=f.features,i=(null===o||void 0===o||null===(y=o.fieldsIndex.get(d))||void 0===y?void 0:y.name)||d,l=(null===o||void 0===o||null===(p=o.fieldsIndex.get(a))||void 0===p?void 0:p.name)||a,t=(null===o||void 0===o||null===(m=o.fieldsIndex.get(v))||void 0===m?void 0:m.name)||v,s=(null===o||void 0===o||null===(F=o.fieldsIndex.get(u))||void 0===F?void 0:F.name)||u,n=(null===o||void 0===o||null===(g=o.fieldsIndex.get(h))||void 0===g?void 0:g.name)||h,I=(null===o||void 0===o||null===(_=o.fieldsIndex.get(c))||void 0===_?void 0:_.name)||c;i&&l&&t&&s&&n&&I&&e.forEach((e=>{const o=e.attributes,d=o[i],a=o[l],v=o[t],u=o[s],h=o[n],c=o[I];d&&a&&v&&u&&"number"==typeof h&&"number"==typeof c&&r.levelsInfo.push({id:d,facilityId:a,longName:v,shortName:u,levelNumber:h,verticalOrder:c})}))}return r}_registerWidget(e){(null===e||void 0===e?void 0:e.persistableViewModels.includes(this))||null===e||void 0===e||e.persistableViewModels.add(this)}_unregisterWidget(e){null===e||void 0===e||e.persistableViewModels.remove(this)}_watchSearchResults(e){null===e||void 0===e||e.on("select-result-floor",(e=>{const i=this.getLevel(e);i&&this.level!==e&&(this.level=e,this.setFloors(i))}))}async _setInitialViewState(e){if(this.view)try{await this.view.when(),await this._setFilterLayers();const l=await this._getFilterFeatures();if(!l)return;if(this.filterFeatures=l,!this.hasFacilities||!this.hasLevels)return void console.error("Facilities and Levels are required for the Floor Filter widget");if(this.hasMultipleSites||(this.filterMenuType="facility"),this.facility&&this.level){this.filterMenuType="facility";const e=this.getFacility(this.facility),i=this.getLevel(this.level);this.site||(this.site=(null===e||void 0===e?void 0:e.siteId)||void 0),this.setFloors(i)}else if(this.facility&&!this.level){this.filterMenuType="facility";const e=this.getFacility(this.facility),i=this.getBaseLevel(e);this.site||(this.site=(null===e||void 0===e?void 0:e.siteId)||void 0),this.level=(null===i||void 0===i?void 0:i.id)||void 0,this.setFloors(i)}else if(!this.facility&&this.level){this.filterMenuType="facility";const e=this.getLevel(this.level),i=this.getFacility(null===e||void 0===e?void 0:e.facilityId);this.facility=(null===i||void 0===i?void 0:i.id)||void 0,this.site||(this.site=(null===i||void 0===i?void 0:i.siteId)||void 0),this.setFloors(e)}else if(!this.site||this.facility||this.level){var i;if(!e||!(0,y.r)(e))return void this.setFloors(null);const l=null===e||void 0===e||null===(i=e.widgets)||void 0===i?void 0:i.floorFilter;if(!l)return void this.setFloors(null);l.site&&!this.site&&(this.site=l.site,this.filterMenuType="facility"),this.setFloors(null)}else this.filterMenuType="site",this.setFloors(null)}catch(l){console.error("Couldn't retrieve sites, facilities, and levels",l)}}_callOverride(e,i){this._override(e,i)}async _updateFloorFilterFromMap(e){var i;if(!e||!(0,y.r)(e))return;const l=null===e||void 0===e||null===(i=e.widgets)||void 0===i?void 0:i.floorFilter;l&&(this._isOverridden("enabled")||(this.enabled=l.enabled),this._isOverridden("longNames")||(this.longNames=l.longNames),this._isOverridden("minimized")||(this.minimized=l.minimized),this._isOverridden("pinnedLevels")||(this.pinnedLevels=l.pinnedLevels),this._isOverridden("site")||(this.site=l.site),this._isOverridden("facility")||(this.facility=l.facility),this._isOverridden("level")||(this.level=l.level))}_computeViewAllModeFloors(e){var i;const{filterFeatures:l}=this;if(null!==(i=e.floorInfo)&&void 0!==i&&i.viewAllMode&&this.hasLevels&&this.hasFacilities&&"base-floors"===this.filterMode){const{level:i,facility:t}=this,s=[];l.levels.levelsInfo.forEach((e=>{const{id:l,facilityId:o}=e;t&&o===t?i&&l===i&&s.push(l):s.push(l)})),e.floorInfo.viewAllLevelIds=new r.default(s)}}};(0,t._)([(0,u.MZ)({value:!1})],m.prototype,"enabled",null),(0,t._)([(0,u.MZ)({value:void 0})],m.prototype,"facility",null),(0,t._)([(0,u.MZ)({value:null})],m.prototype,"filterFeatures",null),(0,t._)([(0,u.MZ)({value:null})],m.prototype,"filterLayers",null),(0,t._)([(0,u.MZ)()],m.prototype,"filterMenuOpen",void 0),(0,t._)([(0,u.MZ)()],m.prototype,"filterMenuType",void 0),(0,t._)([(0,u.MZ)()],m.prototype,"filterMode",void 0),(0,t._)([(0,u.MZ)()],m.prototype,"hasFacilities",null),(0,t._)([(0,u.MZ)()],m.prototype,"hasLevels",null),(0,t._)([(0,u.MZ)()],m.prototype,"hasMultipleSites",null),(0,t._)([(0,u.MZ)({readOnly:!0})],m.prototype,"isNormalMode",null),(0,t._)([(0,u.MZ)({value:void 0})],m.prototype,"level",null),(0,t._)([(0,u.MZ)({value:!1})],m.prototype,"longNames",null),(0,t._)([(0,u.MZ)()],m.prototype,"levelsExpanded",void 0),(0,t._)([(0,u.MZ)({value:!1})],m.prototype,"minimized",null),(0,t._)([(0,u.MZ)({value:!1})],m.prototype,"pinnedLevels",null),(0,t._)([(0,u.MZ)()],m.prototype,"searchTerm",void 0),(0,t._)([(0,u.MZ)({value:void 0})],m.prototype,"site",null),(0,t._)([(0,u.MZ)({readOnly:!0})],m.prototype,"state",null),(0,t._)([(0,u.MZ)()],m.prototype,"view",void 0),(0,t._)([(0,u.MZ)()],m.prototype,"_viewHeightBreakpoint",void 0),(0,t._)([(0,u.MZ)()],m.prototype,"_viewWidthBreakpoint",void 0),(0,t._)([(0,u.MZ)()],m.prototype,"updateWebDocument",null),m=(0,t._)([(0,h.$)("esri.widgets.FloorFilter.FloorFilterViewModel")],m);const F=m}}]);
//# sourceMappingURL=78787.5c57856f.chunk.js.map