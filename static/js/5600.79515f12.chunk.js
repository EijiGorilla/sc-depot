"use strict";(self.webpackChunksc_depot=self.webpackChunksc_depot||[]).push([[5600],{5600:(e,n,i)=>{i.d(n,{Cq:()=>y,Dt:()=>h,JC:()=>g,Rj:()=>v,Sf:()=>f,b:()=>S,gZ:()=>c,w2:()=>p,xZ:()=>w});var t=i(76460),r=i(87663),s=i(50346),o=i(41289),a=i(25647),d=i(31933),l=i(5874);const u=()=>t.A.getLogger("esri.editing.templateUtils");function c(e){return null!=e&&"prototype"in e}function v(e){return p(e)&&!("definition"in e)}function f(e){return p(e)&&"definition"in e}function p(e){return null!=e&&"templateId"in e}function y(e){return f(e)&&"feature"===(null===e||void 0===e?void 0:e.type)&&(null==e.definition||(0,a.sC)(e.definition))}function h(e){return f(e)&&"group"===(null===e||void 0===e?void 0:e.type)&&(null==e.definition||(0,a.Xc)(e.definition))}function g(e){return f(e)&&"preset"===(null===e||void 0===e?void 0:e.type)&&(null==e.definition||(0,a.vf)(e.definition))}function w(e){return f(e)&&null!=(null===e||void 0===e?void 0:e.definition)}const m=e=>null==e||"object"!=typeof e?[]:[..."templates"in e&&Array.isArray(e.templates)?e.templates:[],..."types"in e&&Array.isArray(e.types)?e.types.flatMap((e=>e.templates)):[]];async function S(e,n,i){if(null==n)return e.map((e=>({layer:e,templates:m(e)})));const t=await async function(e,n){const i=await(0,l.Z)(n).load(),t=new Set;for(const r of e)(0,o.kb)(t,I(i,r));return await Promise.all(Array.from(t).map((e=>e.featureService.load()))),t}(e,n);(0,s.throwIfAborted)(i);const a=new Map,c=Array.from(t).map((e=>async function(e){let{serviceInfo:n,out:i,signal:t}=e;const{featureService:o,layersAndTables:a}=n,l=await async function(e){var n;let{featureService:i,layers:t,signal:s}=e;if(null===(n=i.capabilities)||void 0===n||!n.editing.supportsSharedTemplates)return new Map;const o=new Map(t.map((e=>[e.layerId,e]))),a=await i.querySharedTemplates({query:{layers:Array.from(o.keys())},requestOptions:{signal:s}}),d=new Map;for(const l of a)for(const e of l.layerIds)o.has(e)&&(0,r.tE)(d,o.get(e),(()=>[])).push(l);return d}({featureService:o,layers:a.toArray(),signal:t});(0,s.throwIfAborted)(t);for(const[r,s]of l.entries())if(0!==s.length)if((0,d.F2)(r)){var u;const e=_(s),n=[],t=null!==(u=e.get(1/0))&&void 0!==u?u:n;for(const s of r.sublayers){var c;const r=null!==(c=e.get(s.subtypeCode))&&void 0!==c?c:n;i.set(s,[...r,...t])}}else i.set(r,s)}({serviceInfo:e,out:a,signal:i,view:n}))),v=await Promise.allSettled(c);for(const r of v.filter((e=>"rejected"===e.status)))u().warn("Failed to fetch shared templates for service. Will use standard templates if available.",r.reason);return e.map((e=>{var n;return{layer:e,templates:null!==(n=a.get(e))&&void 0!==n?n:m(e)}}))}function I(e,n){return(0,d.Sv)(n)&&n.parent?e.tablesAndLayersLookup.get(n.parent):(0,d.yZ)(n)?e.tablesAndLayersLookup.get(n):null}function _(e){const n=new Map;for(const t of e){var i;(0,r.tE)(n,null!==(i=t.subtypeCode)&&void 0!==i?i:1/0,(()=>[])).push(t)}return n}},5874:(e,n,i)=>{i.d(n,{Z:()=>U});var t=i(35143),r=i(55171),s=i(19276),o=i(50076),a=i(54099),d=i(49304),l=i(76460),u=i(87663),c=i(91291),v=i(50346),f=i(67993),p=i(68134),y=i(90534),h=i(46053),g=(i(81806),i(47249),i(85842)),w=i(19451),m=i(13096),S=i(31933),I=i(24883),_=i(96422),b=i(8163),A=i(91967);let L=class extends A.default{constructor(e){super(e),this.layers=new s.default,this.lockType="none",this.tables=new s.default,this.versionInfo=null,this.versionService=null}get layersAndTables(){return new s.default([...this.layers.toArray(),...this.tables.toArray()])}updateLockType(){var e;this.lockType=this.versionInfo&&null!==(e=this.versionService.getLockType(this.versionInfo.versionIdentifier))&&void 0!==e?e:"none"}get featureServiceVersion(){var e,n;return null!==(e=null===(n=this.featureService.sourceJSON)||void 0===n?void 0:n.currentVersion)&&void 0!==e?e:0}};(0,t._)([(0,h.MZ)({constructOnly:!0})],L.prototype,"canCreateVersion",void 0),(0,t._)([(0,h.MZ)({constructOnly:!0})],L.prototype,"canEditVersionedData",void 0),(0,t._)([(0,h.MZ)({constructOnly:!0})],L.prototype,"featureService",void 0),(0,t._)([(0,h.MZ)({constructOnly:!0})],L.prototype,"layers",void 0),(0,t._)([(0,h.MZ)()],L.prototype,"layersAndTables",null),(0,t._)([(0,h.MZ)()],L.prototype,"lockType",void 0),(0,t._)([(0,h.MZ)({constructOnly:!0})],L.prototype,"tables",void 0),(0,t._)([(0,h.MZ)()],L.prototype,"versionInfo",void 0),(0,t._)([(0,h.MZ)({constructOnly:!0})],L.prototype,"versionService",void 0),(0,t._)([(0,h.MZ)()],L.prototype,"hasAdvancedEditingUserTypeExtension",void 0),(0,t._)([(0,h.MZ)()],L.prototype,"loggedInServiceUser",void 0),(0,t._)([(0,h.MZ)()],L.prototype,"featureServiceVersion",null),L=(0,t._)([(0,g.$)("esri.undoredo.support.ServiceVersionInfo")],L);var T=i(54265);const V=new Map;function U(e){return(0,u.tE)(V,e,(()=>{const n=new M({view:e});return e.addHandles({remove(){V.delete(e),n.destroy()}}),n.load().catch((e=>{l.A.getLogger("esri.views.Services").error("Failed to load service metadata",e)})),n}))}let M=class extends(d.A.LoadableMixin(c.A.EsriPromiseMixin(a.A.EventedAccessor))){constructor(e){super(e),this._updatingHandles=new w.U,this.items=new s.default,this.tablesAndLayersLookup=new f.A,this.additionalLayers=new s.default,this._debouncedCheckAndUpdateServiceInfos=(0,v.debounce)((async()=>{const e=[];for(const i of this.items){var n;if(0===i.layersAndTables.length)continue;const t=i.layersAndTables.getItemAt(0);(null===t||void 0===t?void 0:t.gdbVersion)!==(null===(n=i.versionInfo)||void 0===n?void 0:n.versionIdentifier.name)&&e.push(i)}0!==e.length&&(await(0,p.whenOnce)((()=>!this.updating)),await this._updateVersionInfos(e))})),this._debouncedLayersChanged=(0,v.debounce)((async()=>{const e=this._detectNewLayersAndTables();0!==e.length&&(await(0,p.whenOnce)((()=>!this._updatingHandles.updating)),await this._updatingHandles.addPromise((async()=>{const n=new Set;for(const t of e)if("feature"===t.type||"subtype-group"===t.type){if(!t.url)continue;const e=(0,m.qg)(t.url).url.path,r=this._findServiceInfo(e);if(r)this.tablesAndLayersLookup.set(t,r),t.isTable?r.tables.push(t):r.layers.push(t);else if(!n.has(e))try{await this._addServiceInfo(e,t)}catch(i){l.A.getLogger(this).error("Failed to load feature service: ".concat(e),i)}finally{n.add(e)}}})()))})),this._processed=new Set}destroy(){this._set("view",null),this.items.removeAll(),this.tablesAndLayersLookup.clear()}async load(e){return(0,v.throwIfAborted)(e),this.addHandles([(0,p.watch)((()=>this._allLayersAndTables),(()=>{this._debouncedLayersChanged().catch((e=>{l.A.getLogger(this).warn("Failed to update service info",e)}))})),(0,p.watch)((()=>this.items.map((e=>e.layersAndTables.map((e=>{var n;return null!==(n=e.gdbVersion)&&void 0!==n?n:""})).join(",")))),(()=>{this.checkAndUpdateServiceInfos().catch((e=>{l.A.getLogger(this).warn("Failed to update service info",e)}))}))]),this.addResolvingPromise(this._debouncedLayersChanged()),this}get updating(){return"loading"===this.loadStatus||this._updatingHandles.updating}checkAndUpdateServiceInfos(){return this._debouncedCheckAndUpdateServiceInfos()}changeVersion(e,n,i){return this._updatingHandles.addPromise((async()=>{await this._changeVersionInternal(e,n,i)})())}createVersion(e){return this._updatingHandles.addPromise((async n=>{const i=e.featureServerUrl,t=this._findServiceInfo(i);if(null===t||void 0===t||!t.versionService)throw new o.default("services:no-version-management-service");const r=t.hasAdvancedEditingUserTypeExtension,s=t.loggedInServiceUser.toUpperCase(),a=function(e){return!e||0===e.trim().length}(e.ownerName)?s:null===(n=e.ownerName)||void 0===n?void 0:n.trim().toUpperCase();if(a!==s){if(t.featureServiceVersion<=11.1)throw new o.default("services:versioning-api-error");if(!r)throw new o.default("services:no-advanced-editing-user-type-extension")}if("SDE"===(null===a||void 0===a?void 0:a.toUpperCase())&&"DEFAULT"===e.versionName.toUpperCase())throw new o.default("services:no-valid-version-name");{const n=await t.versionService.getVersionInfos();if(null!==n&&void 0!==n&&n.find((n=>n.versionIdentifier.name.toUpperCase()===(a+"."+e.versionName).toUpperCase()||n.versionIdentifier.name.toUpperCase()===(s+"."+e.versionName).toUpperCase())))throw new o.default("services:no-valid-version-name")}const d=await t.versionService.createVersion({versionName:e.versionName,access:a!==s?"public":e.access,description:e.description});if(a!==s){const{guid:n,name:i}=d.versionIdentifier;await t.versionService.alterVersion({guid:n,name:i},{ownerName:a,access:e.access})}e.switchToVersion&&await this._changeVersionInternal(i,d.versionIdentifier.name,d.versionIdentifier.guid),this.emit("version-created",{versionIdentifier:d.versionIdentifier,versionManagementService:t.versionService})})())}deleteVersion(e,n,i){return this._updatingHandles.addPromise((async()=>{const t=this._findServiceInfo(e);if(null===t||void 0===t||!t.versionService)throw new o.default("services:no-version-management-service");if(t.featureServiceVersion<=11.1)throw new o.default("services:versioning-api-error");if(!t.hasAdvancedEditingUserTypeExtension)throw new o.default("services:no-advanced-editing-user-type-extension");const r={name:n,guid:i};await t.versionService.deleteVersion(r)&&(await this._updateVersionInfo(t),this.emit("version-deleted",{versionIdentifier:r,versionManagementService:t.versionService}))})())}startEditing(e){return this._updatingHandles.addPromise((async(n,i)=>{const t=this._findServiceInfo(e);if(null===t||void 0===t||!t.versionService)throw new o.default("services:no-version-management-service");if(!t.hasAdvancedEditingUserTypeExtension)throw new o.default("services:no-advanced-editing-user-type-extension");const r=null!==(n=null===(i=t.versionInfo)||void 0===i?void 0:i.versionIdentifier)&&void 0!==n?n:{name:t.versionService.defaultVersionIdentifier.name,guid:t.versionService.defaultVersionIdentifier.guid};let s=!0;("none"!==t.versionService.getLockType(r)||(s=await t.versionService.startReading(r),s))&&(s=await t.versionService.startEditing(r),t.updateLockType())})())}finishEditing(e,n){return this._updatingHandles.addPromise((async(i,t)=>{const r=this._findServiceInfo(e);if(null===r||void 0===r||!r.versionService)throw new o.default("services:no-version-management-service");if(!r.hasAdvancedEditingUserTypeExtension)throw new o.default("services:no-advanced-editing-user-type-extension");const s=null!==(i=null===(t=r.versionInfo)||void 0===t?void 0:t.versionIdentifier)&&void 0!==i?i:{name:r.versionService.defaultVersionIdentifier.name,guid:r.versionService.defaultVersionIdentifier.guid},a=r.versionService.getLockType(s);if("none"!==a)return"read"===a?(await r.versionService.stopReading(s),void r.updateLockType()):"edit"===a?(await r.versionService.stopEditing(s,n),await r.versionService.stopReading(s),void r.updateLockType()):void 0})())}async _changeVersionInternal(e,n,i){var t,r,s;const a=this._findServiceInfo(e);if(null===a||void 0===a||!a.versionService)throw new o.default("services:no-version-management-service");const d=null!==(t=null===(r=a.versionInfo)||void 0===r?void 0:r.versionIdentifier)&&void 0!==t?t:{name:a.versionService.defaultVersionIdentifier.name,guid:a.versionService.defaultVersionIdentifier.guid},l={name:n,guid:i};await a.versionService.changeVersion(null===(s=this.view)||void 0===s?void 0:s.map,d,l)&&await this._updateVersionInfo(a)}async _updateVersionInfo(e){var n;const i=e.versionService;if(!i)return;if(0===e.layersAndTables.length)return;const t=null===(n=e.layersAndTables.getItemAt(0))||void 0===n?void 0:n.gdbVersion,r=t?await i.getVersionIdentifierFromName(t):i.defaultVersionIdentifier;e.versionInfo=await i.getVersionInfoExtended(r)}_findServiceInfo(e){var n;return null!==(n=this.items.find((n=>n.featureService.url===e)))&&void 0!==n?n:null}_removeFeatureService(e){this.items.remove(e)}async _findPortal(e){const n=null===r.id||void 0===r.id?void 0:r.id.findServerInfo(null!==e&&void 0!==e?e:"");if(null===n||void 0===n||!n.owningSystemUrl)return null;const i="".concat(n.owningSystemUrl,"/sharing/rest"),t=I.default.getDefault();return null!==t&&void 0!==t&&t.loaded&&(0,y.normalize)(t.restUrl)===(0,y.normalize)(i)?t:new I.default({authMode:"immediate",url:n.owningSystemUrl}).load()}_updateVersionInfos(e){return this._updatingHandles.addPromise((async()=>{for(const n of e)await this._updateVersionInfo(n).catch((e=>{l.A.getLogger(this).error("Failed to update version details",e)}))})())}async _addServiceInfo(e,n){var i;const t=new b.default({url:e});await t.load();const r=await this._findPortal(e),o=null===r||void 0===r||null===(i=r.user)||void 0===i?void 0:i.username;let a=!1;o&&(a=await(0,_.RE)(r,o,"advediting"));let d=null;t.versionManagementServiceUrl&&(d=new T.default({url:t.versionManagementServiceUrl}),await d.load());const l=n.isTable?[]:[n],u=n.isTable?[n]:[],c=new L({loggedInServiceUser:null!==o&&void 0!==o?o:"",hasAdvancedEditingUserTypeExtension:a,versionInfo:null,lockType:"none",canEditVersionedData:!0,canCreateVersion:!0,featureService:t,versionService:d,layers:new s.default(l),tables:new s.default(u)});return d&&await this._updateVersionInfo(c),this.items.push(c),this.tablesAndLayersLookup.set(n,c),n.isTable?c.tables.push(n):c.layers.push(n),c}get _allLayersAndTables(){return[...this.view.map.allLayers,...this.view.map.allTables,...this.additionalLayers]}_detectNewLayersAndTables(){const e=new Set(this._allLayersAndTables),n=[];for(const i of e)"feature"!==i.type&&"subtype-group"!==i.type||this._processed.has(i)||n.push(i);for(const i of this._processed)if(!e.has(i)&&((0,S.F2)(i)||(0,S.yZ)(i))){const e=this.tablesAndLayersLookup.get(i);if(!e)continue;this.tablesAndLayersLookup.delete(i),i.isTable?e.tables.remove(i):e.layers.remove(i),0===e.layersAndTables.length&&this._removeFeatureService(e)}return this._processed=e,n}};(0,t._)([(0,h.MZ)({constructOnly:!0})],M.prototype,"view",void 0),(0,t._)([(0,h.MZ)()],M.prototype,"items",void 0),(0,t._)([(0,h.MZ)()],M.prototype,"tablesAndLayersLookup",void 0),(0,t._)([(0,h.MZ)()],M.prototype,"additionalLayers",void 0),(0,t._)([(0,h.MZ)()],M.prototype,"updating",null),(0,t._)([(0,h.MZ)()],M.prototype,"_allLayersAndTables",null),M=(0,t._)([(0,g.$)("esri.undoredo.support.Services")],M)},25647:(e,n,i)=>{function t(e){return"feature"===e.type}function r(e){return"group"===e.type}function s(e){return"preset"===e.type}i.d(n,{Xc:()=>r,sC:()=>t,vf:()=>s})},96422:(e,n,i)=>{i.d(n,{Kw:()=>s,RE:()=>a,Sl:()=>o});var t=i(55171),r=i(3825);async function s(e,n,i){var s;if(!(null===t.id||void 0===t.id?void 0:t.id.findCredential(e.restUrl)))return null;if("loaded"===e.loadStatus&&""===n&&null!==(s=e.user)&&void 0!==s&&s.sourceJSON&&!1===i)return e.user.sourceJSON;const o={responseType:"json",query:{f:"json"}};if(i&&(o.query.returnUserLicenseTypeExtensions=!0),""===n){const n=await(0,r.default)(e.restUrl+"/community/self",o);if(n.data){const e=n.data;if(null!==e&&void 0!==e&&e.username)return e}return null}const a=await(0,r.default)(e.restUrl+"/community/users/"+n,o);if(a.data){const e=a.data;return e.error?null:e}return null}async function o(e,n,i){var t,r;const o=await s(e,n,!0);return null!==(t=null===o||void 0===o||null===(r=o.privileges)||void 0===r?void 0:r.includes(i))&&void 0!==t&&t}async function a(e,n,i){var t,r;const o=await s(e,n,!0);return null!==(t=null===o||void 0===o||null===(r=o.userLicenseTypeExtensions)||void 0===r?void 0:r.includes(i))&&void 0!==t&&t}}}]);
//# sourceMappingURL=5600.79515f12.chunk.js.map